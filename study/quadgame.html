<!DOCTYPE html>
<html>
  <head>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/dist/papaparse.min.js"></script>
  <script type="module" src="/js/ds.js"></script>
  <script src="/js/scripts.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">


<style>
html,body {
  width: 100%;
  height: 100%;
  margin: 0; 
  padding: 0;
  background-color: var(--bg-color);
}

body {
  overflow: hidden;
}


rect {
  background-color: var(--fg-color);
}

.main {
  display: block;
  touch-action: none;
  height: 100%;
  cursor: crosshair;
}
.fg-fill {
  fill: var(--fg-color);
}
.bg-fill {
  fill: var(--bg-color);
}
.fg-stroke {
  stroke: var(--fg-color);
}

:root {
  --bg-color: rgb(100% 100% 100%);
  --fg-color: rgb(9.09% 10.18% 10.88%);
}

</style>
 </head>
<body>

<div id="cover"></div>

<div id="welcome" class="screen text scroll">
<!-- Welcome screen -->
  <div class="page">
  <div class="paragraph">
  <div class="title">
    <h1>Research Study</h1>
  </div>
  <hr>
  <div class="content">
    <p> Welcome! Thanks for choosing to participate in our research study. 
    <h2>ðŸ“œ Instructions 
      <span style="font-size: 12px; color: maroon;">Please read this carefully!</span>
    </h2>
    <p> Today you will participate in a <b>human/machine collaboration research study</b>. Please be comfortably seated at your computer or device (mouse, touchscreen). Your goal is to <i>move your cursor</i> to achieve the <i>best overall performance</i>.
    <p> On the next page, you will start with a short training phase to enable you to acclimate and gain proficiency with the system. After the training, you will follow on-screen instructions to provide <i>input</i> that makes an object satisfy an <i>objective</i>. For example, you may be asked to make an object as <i>small</i> or <i>large</i> as possible.
    <p> After each experiment, we will ask a brief series of questions to evaluate the interaction. The entire experimental session should take between 30 minutes and two hours. You are encouraged to take breaks during the allotted times.
    <p> You are not required to complete the experimental session; you can excuse yourself at any time.
    <h2> ðŸ”¬ Benefits of the Scientific Research </h2>
    <p> We are studying how humans interact with machines like robots using computer interfaces, and what changes can be made to improve these interfaces.
    <p> This research may contribute to safer, more intuitive, or more adaptive human/machine interfaces with applications in virtual/augmented reality, teleoperated robotics, or assistive devices.
    <h2> ðŸŽ¬ Start the Study! </h2>
    <p> If you understood the instructions correctly, press 
    <b>DONE</b>
    to proceed.
    <hr style="display: none;">
    <button id="done_btn"> DONE </button>
  </div>
</div>
</div>
</div>
<div id="progress" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1>Study Progress</h1>
      </div>
      <hr>
      <div class="content">
        <p> Take a break!
        <p> <b>Trials:</b> 0/10  
        <br>
         <b>Time remaining:</b> ~3min
        <br>
        <br>
        <hr style="display:none;">
        <button>CONTINUE</button>
      </div>
    </div>
  </div>
</div>
<div id="survey" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1>Task Load Survey</h1>
      </div>
      <hr>
      <div class="content tls">
        <p class="ptls">
        <span class="labeltls">Mental Demand</span>
        How mentally demanding was the task?
        <br>
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Physical Demand</span>
        How physically demanding was the task?
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Temporal Demand</span>
        How hurried or rushed was the pace of the task?
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Performance</span>
        How successful were you in accomplishing what you were asked to do?
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Perfect</span>
        <span class="labeltls-right">Failure</span>
        <p class="ptls">
        <span class="labeltls">Effort</span>
        How hard did you have to work to accomplish your level of performance?
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Frustration</span>
        How insecure, discouraged, irritated, stressed, and annoyed were you?
        <p>
        <input type="range" min="-10" max="10" value="0"></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
      </div>
    </div>
  </div>
</div>
<div id="ending" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1> Thank you for participating!  </h1>
      </div>
      <hr>
      <div class="content">
        <p> You have now completed this task and your data has been saved.
        <p> If you would like to be contacted for future studies, please enter your email:
        <br>
        <input type="email" placeholder="email"></input> (optional)
        <p> Any feedback? Let us know here:
        <br>
        <textarea placeholder="I think that..."></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Main study graphics -->
<div id="study_out" class="screen main">
  <svg width="100%" height="100%">
    <rect id="output" class="fg-fill" width="70%" height="10%" x="15%" y="70%"></rect>
    <text x="50%" y="75%" dominant-baseline="middle" text-anchor="middle" class="bg-fill"> 
    keep this as small as possible
    </text>
  </svg>
</div>

<div id="study_in" class="screen">
  <svg width="100%" height="100%">
    <svg id="input" x="50%" y="90%" overflow="visible"> 
      <polygon class="fg-fill" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0">
    </svg>
  </svg>
</div>

<div id="study_target" class="screen">
  <svg width="100%" height="100%">
    <svg id="target" x="50%" y="90%" overflow="visible"> 
      <polygon class="fg-stroke" stroke-dasharray="1,1" fill="none" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0">
    </svg>
  </svg>
</div>

<div id="intro" class="screen text" >
  <svg width="100%" height="100%">
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"> 
    move the cursor to fill the diamond
    </text>
  </svg>
    <!--<svg overflow="visible" width="40" height="40" viewbox="-20 -20 40 40" >
      <polygon  fill="black" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0">
    </svg>
    to fill
    <svg overflow="visible" width="40" height="40" viewBox="-20 -20 40 40">
      <polygon  stroke-dasharray="1,1" fill="none" stroke="black" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0">
      </polygon>
    </svg>-->
</div>

<div id="break" class="screen text">
  <div class="paragraph">
    <p>Trial: # 1 of 10
    <p>Time remaining: 10min
  </div>
</div>
<br>
<br>
<div class="footer">
  <div class="footer-1">
    <a class="setScreen" title="welcome"> Welcome</a> | 
    <a class="setScreen" title="intro study_in study_target"> Instructions</a> |
    <a class="setScreen" title="study_in study_out"> Start Study</a> |
    <a class="setScreen" title="progress"> Progress </a> |
    <a class="setScreen" title="survey"> Survey </a> |
    <a class="setScreen" title="break"> Break </a> |
    <a class="setScreen" title="ending"> Ending </a> 
  </div>
  <div class="footer-2">
  </div>
  <div class="footer-3">
  </div>
</div>
<script type="text/javascript">

document.querySelector('.footer').classList.add('hidden')
function debug(val=true) {
  if (val)
    document.querySelector('.footer').classList.remove('hidden')
  else
    document.querySelector('.footer').classList.add('hidden')
}

mountListeners()


let ds, study;
let pid = getQuery().pid || "guest";

window.onload = function() {
  function touchstart(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  window.addEventListener("touchstart", touchstart);

  stateMachine = CreateMachine({
    id: 'study',
    initial: 'welcome',
    states: {
      welcome: {
        screen: 'welcome',
        on: {
          CLICK: {
            el: document.getElementById('done_btn'),
            target: 'intro'
          }
        }
      },
      intro: {
        screen: 'intro study_in study_target',
        onEntry: function() {
          pid = prompt('enter your name or ID', pid)
          console.log('pid='+pid)
          startController(study, pid)
        },
      }
    }
  })
  ds = DynamSpace({ 
    update_fn: update, 
    experiment: 'siso'})

  getStudy("https://api.dynam.space/studies/sample")

}

function getStudy(url) {
  fetch(url)
  .then(response => response.json())
  .then(json => study = json)
  .then(()=>
    document.getElementById('cover').style = "display: none;"
  )
}


function startController(study, pid) {
  if(study) {
    console.log(study)
    ds.mount(study, 'https://api.dynam.space/upload/'+pid)
  } else {
    console.log('study not loaded')
  }
}


function mountListeners() {
  /* Footer */
  const setScreens = document.querySelectorAll('.setScreen');
  setScreens.forEach( function(v)  {
    v.addEventListener("click", (e) => {
      setScreen(v.getAttribute('title'))
    })
  })
}

function setScreen(screen) {
  console.log('setScreen('+screen+')')
  const screens = document.querySelectorAll(".screen");
  screens.forEach( (v) => {
    if(screen.split(" ").includes(v.getAttribute("id"))) {
      v.classList.remove("hidden")
    } else {
      v.classList.add("hidden")
    }
  })
}

let myMsg = "";
let myState = "";
function update({msg, state}={}) {
  if (msg) myMsg = msg
  msg = myMsg + " | "
  if (state && state != myState) {
    myState = state
    console.log(state)
    switch(state) {
      case 'go': 
        setScreen('study_in study_out')
        break;
      case 'standby':
        setScreen('intro study_in study_target')
        break;

    }
  }

  if(ds) {
    let space = ds.getSpace()
    try {
      Object.keys(space).forEach((label) => {
        msg += "<b>"+ label+".</b>"
        Object.keys(space[label]).forEach((v) => {
          msg += v + ": " + space[label][v].toFixed(2) + " | "
        })
      })
    }
    catch (err) {
      msg += JSON.stringify(space)
    }
  } else {
    msg = "..."
  }
  printStatus(msg)
}

textbar = document.querySelector(".footer-3")
function printStatus(status) {
  textbar.innerHTML = status
}

window.addEventListener("DOMContentLoaded", function() {
  shortcut.set({
    "f": function () {
      document.querySelector('.footer').classList.remove('hidden')
    }
  })
})

//window.onmousemove = mousemove
//window.ontouchmove = touchmove

</script>

 </body>
</html>
