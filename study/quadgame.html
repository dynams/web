<!DOCTYPE html>
<html>
  <head>
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/dist/papaparse.min.js"></script>
  <script type="module" src="/js/ds.js"></script>
  <script src="/js/scripts.js"></script>
  <script type="text/javascript" src="/study/quadgame.json"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">


<style>
html,body {
  width: 100%;
  height: 100%;
  margin: 0; 
  padding: 0;
  background-color: var(--bg-color);
}

body {
  overflow: hidden;
}

rect {
  background-color: var(--fg-color);
}

.main {
  display: block;
  touch-action: none;
  height: 100%;
  cursor: crosshair;
}
.fg-fill {
  fill: var(--fg-color);
}
.bg-fill {
  fill: var(--bg-color);
}
.fg-stroke {
  stroke: var(--fg-color);
}

:root {
  --bg-color: rgb(100% 100% 100%);
  --fg-color: rgb(9.09% 10.18% 10.88%);
}

</style>
 </head>
<body>

<div id="cover">
  <div class="message" style="top:50%">
    Loading...
  </div>
</div>

<div id="idle" class="screen">
  <div class="message" style="top:50%">
    Click to start.
  </div>
</div>

<div id="welcome" class="screen text scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1>Research Study</h1>
      </div>
      <hr>
      <div class="content">
        <p> Welcome! Thanks for choosing to participate in our research study. 
        <h2>📜 Instructions 
          <span style="font-size: 12px; color: maroon;">Please read this carefully!</span>
        </h2>
        <p> Today you will participate in a <b>human/machine collaboration research study</b>. Please be comfortably seated at your computer or device (mouse, touchscreen). Your goal is to <i>move your cursor</i> to achieve the <i>best overall performance</i>.
        <p> On the next page, you will start with a short training phase to enable you to acclimate and gain proficiency with the system. 
        After the training, you will follow on-screen instructions to provide <i>input</i> that makes an object satisfy an <i>objective</i>. 
        For example, you may be asked to make an object as <i>small</i> or <i>large</i> as possible.
        <p> After each experiment, we will ask a brief series of questions to evaluate the interaction. 
        The entire experimental session should take between 30 minutes and two hours. 
        You are encouraged to take breaks during the allotted times.
        <p> You are not required to complete the experimental session; you can excuse yourself at any time.
        <h2> 🔬 Benefits of the Scientific Research </h2>
        <p> We are studying how humans interact with machines like robots using computer interfaces, and what changes can be made to improve these interfaces.
        <p> This research may contribute to safer, more intuitive, or more adaptive human/machine interfaces with applications in virtual/augmented reality, teleoperated robotics, or assistive devices.
        <h2> 🎬 Start the Study! </h2>
        <p> If you understood the instructions correctly, press 
        <b>DONE</b>
        to proceed.
        <hr style="display: none;">
        <button id="btn_welcome"> 
          <div class="timer" id="timer_welcome"></div>
          DONE 
        </button>
      </div>
    </div>
  </div>
</div>

<div id="error" class="screen">
  <div class="message" style="top:50%; padding: 2em; background-color: rgba(213,165,165, 0.8); " >
    Timeout! Refresh page to restart.
  </div>
</div>

<div id="rest" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1>Study Progress</h1>
      </div>
      <hr>
      <div class="content">
        <p> Take a rest!
        <div id="progress_div">
        </div>
        <br>
        <br>
        <hr style="display:none;">
        <button id="btn_continue">
          <div class="timer" id="timer_continue"></div>
          CONTINUE</button>
      </div>
    </div>
  </div>
</div>

<div id="survey" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1>Task Load Survey</h1>
      </div>
      <hr>
      <div class="content tls">
        <p class="ptls">
        <span class="labeltls">Mental Demand</span>
        How mentally demanding was the task?
        <br>
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Physical Demand</span>
        How physically demanding was the task?
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Temporal Demand</span>
        How hurried or rushed was the pace of the task?
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Performance</span>
        How successful were you in accomplishing what you were asked to do?
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Perfect</span>
        <span class="labeltls-right">Failure</span>
        <p class="ptls">
        <span class="labeltls">Effort</span>
        How hard did you have to work to accomplish your level of performance?
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <p class="ptls">
        <span class="labeltls">Frustration</span>
        How insecure, discouraged, irritated, stressed, and annoyed were you?
        <p>
        <input type="range" min="-10" max="10" value="0" disabled></input>
        <span class="labeltls-left">Very Low</span>
        <span class="labeltls-right">Very High</span>
        <br/>
        <hr style="display: none;">
        <button id+"btn_survey">
          <div class="timer" id="timer_survey"></div>
          CONTINUE</button>
      </div>
    </div>
  </div>
</div>

<div id="end" class="screen scroll">
  <div class="page">
    <div class="paragraph">
      <div class="title">
        <h1> Thank you for participating!  </h1>
      </div>
      <hr>
      <div class="content">
        <p> You have now completed this task and your data has been saved.
        <p> If you would like to be contacted for future studies, please enter your email:
        <br>
        <input type="email" placeholder="email" disabled></input> (optional)
        <p>
        <p> Any feedback? Let us know here:
        <br>
        <textarea placeholder="I think that..." disabled></textarea>
        <p>
        Deidentify your email 
        <input type="checkbox" checked disabled></input> 
        and feedback 
        <input type="checkbox" checked disabled></input> 
      </div>
    </div>
  </div>
</div>

<!-- Main study graphics -->
<div id="study_out" class="screen main">
  <svg width="100%" height="100%">
    <rect id="output" class="fg-fill" width="70%" height="10%" x="15%" y="70%"></rect>
  </svg>
  <div class="message" style="color: white; top: 73%">
    <span style="vertical-align: middle">
    keep this as small as possible
    </span>
  </div>
</div>

<div id="intro" class="screen text" >
  <div class="message" style="top: 50%;">
    <div class="timer" id="timer_intro"></div>
    click or touch the cursor 
  </div>
</div>

<div id="study_in" class="screen">
  <svg width="100%" height="100%">
    <svg id="input" x="50%" y="90%" overflow="visible"> 
      <polygon id="input_poly" class="fg-fill" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0" z-order="10">
    </svg>
  </svg>
</div>

<div id="study_target" class="screen">
  <div class="message" style="top: 50%;">
    <div class="timer" class="timer_target"></div>
    move the cursor to fill the diamond
  </div>
  <svg width="100%" height="100%">
    <svg id="target" x="50%" y="90%" overflow="visible"> 
      <polygon class="fg-stroke" stroke-dasharray="1,1" fill="none" transform="scale(2)"
      points="0,-10 10,0 0,10 -10,0">
    </svg>
  </svg>
</div>


<br>
<br>
<div class="footer">
  <div class="footer-1">
    <a class="setScreen" title="welcome"> Welcome</a> | 
    <a class="setScreen" title="intro study_in study_target"> Instructions</a> |
    <a class="setScreen" title="study_in study_out"> Start Study</a> |
    <a class="setScreen" title="rest"> Rest </a> |
    <a class="setScreen" title="survey"> Survey </a> |
    <a class="setScreen" title="end"> End </a> 
  </div>
  <div class="footer-2">
  </div>
  <div class="footer-3">
  </div>
</div>
<script type="text/javascript">





document.querySelector('.footer').classList.add('hidden')
function debug(val=true) {
  if (val)
    document.querySelector('.footer').classList.remove('hidden')
  else
    document.querySelector('.footer').classList.add('hidden')
}

mountListeners()


let ds, study, studyMachine;
let pid = getQuery().pid || "guest";

window.onload = function() {
  function touchstart(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  window.addEventListener("touchstart", touchstart);

  ds = DynamSpace({ 
    update_fn: update, 
    experiment: 'siso'})

  //getStudy("https://api.dynam.space/studies/sample")
  //getStudy("http://localhost:8000/studies/sample")
  study = {"sid":"0","desc":"sample study","tasks":[{"id":"C00","protocol":"graddescent-0","params":{"seed":300.0}},{"id":"000","protocol":"quadgame-1","params":{"lr":0.1,"l":0.5049129395702733,"xflip":1.0}},{"id":"001","protocol":"quadgame-1","params":{"lr":0.1,"l":0.5049129395702733,"xflip":0.0}},{"id":"002","protocol":"quadgame-1","params":{"lr":0.1,"l":0.0,"xflip":1.0}},{"id":"003","protocol":"quadgame-1","params":{"lr":0.1,"l":0.1305118903667876,"xflip":0.0}},{"id":"004","protocol":"quadgame-1","params":{"lr":0.01,"l":0.5049129395702733,"xflip":1.0}},{"id":"005","protocol":"quadgame-1","params":{"lr":0.01,"l":0.0,"xflip":0.0}},{"id":"006","protocol":"quadgame-1","params":{"lr":0.01,"l":0.0,"xflip":1.0}},{"id":"007","protocol":"quadgame-1","params":{"lr":0.1,"l":0.0,"xflip":0.0}},{"id":"008","protocol":"quadgame-1","params":{"lr":0.1,"l":0.1305118903667876,"xflip":1.0}},{"id":"009","protocol":"quadgame-1","params":{"lr":0.01,"l":0.1305118903667876,"xflip":1.0}},{"id":"010","protocol":"quadgame-1","params":{"lr":0.01,"l":0.1305118903667876,"xflip":0.0}},{"id":"011","protocol":"quadgame-1","params":{"lr":0.01,"l":0.5049129395702733,"xflip":0.0}}]}
  document.getElementById('cover').style = "display: none;"

  //worker = new Worker('/js/timer.js')
  //worker.onmessage = function() { }

  studyMachine = CreateMachine({
    id: 'study',
    initial: 'load',
    context: {
      elapsed: 0,
      duration: 0,
    },

    states: {
      load: {
        screen: 'idle',
        on: { 
          LOAD: {
          },
          CLICK: { 
            target: 'welcome' 
          } 
        }
      },
      welcome: {
        screen: 'welcome',
        on: {
          CLICK: {
            target: 'intro',
            el: document.getElementById('btn_welcome')
          },
          TIMER: {
            target: 'intro',
            duration: 120,
            el: document.getElementById('timer_welcome')
          }
        },
        onEntry: function () {
          console.log("Welcome!")
          console.log(">> Starting controller")
          ds.load(study, 'https://api.dynam.space/upload/'+pid )
        }
      },

      error: {
        screen: 'welcome error',
      },

      intro: {
        screen: 'intro study_in',
        onEntry: function() {
          pid = prompt('enter your name or ID', pid)
          console.log('pid='+pid)
        },
        onExit: function() {
          ds.start()
        },
        on: {
          CLICK: {
            el: document.getElementById('input_poly'),
            target: 'standby'
          },
          TIMER: {
            el: document.getElementById('timer_intro'),
            duration: 5,
            target: 'standby'
          }
        }
      },

      standby: {
        screen: 'study_in study_target',
      },
      ready: {
        screen: 'study_in study_target'
      },
      go: { 
        screen: 'study_in study_out'
      },

      rest: {
        screen: 'rest',
        onEntry: function() {
          ds.pause()
          const prog = ds.progress(30)
          let str = "<p><b>✅ Completed tasks:</b> "+prog.current+"/"+prog.total;
          if(prog.time_remaining) {
            str += "<p><b>⏱ Remaining time: </b> ~"+prog.time_remaining +" min";
          }
          const el = document.getElementById('progress_div')
          el.innerHTML = str;

        },
        onExit: function() {
          ds.resume()
        },
        on: {
          CLICK: {
            el: document.getElementById('btn_continue'),
            target: 'standby'
          },
          TIMER: {
            el: document.getElementById('timer_continue'),
            duration: 30,
            target: 'standby'
          }
        }
      },

      survey: {
        screen: 'survey',
        on: {
          CLICK: {
            el: document.getElementById('btn_survey'),
            target: 'end'
          },
          TIMER: {
            el: document.getElementById('timer_survey'),
            duration: 120,
            target: 'end'
          }
        }
      },
      end: {
        screen: 'end'
      }
    }
  })
}

function getStudy(url) {
  fetch(url)
  .then(response => response.json())
  .then(json => study = json)
  .then(()=>
    document.getElementById('cover').style = "display: none;"
  )
}



function mountListeners() {
  /* Footer */
  const setScreens = document.querySelectorAll('.setScreen');
  setScreens.forEach( function(v)  {
    v.addEventListener("click", (e) => {
      setScreen(v.getAttribute('title'))
    })
  })
}

let myMsg = "";
let myState = "initial";
function update({msg, state}={}) {
  if (msg) myMsg = msg
  msg = state + " | " + myMsg + " | " 
  if (state && state != myState) {
    myState = state
    switch(state) {
      case 'go': 
        //studyMachine.transitionTo('go')
        setScreen('study_in study_out')
        break;
      case 'standby':
        //studyMachine.transitionTo('standby')
        setScreen('study_in study_target')
        break;
      case 'rest':
        studyMachine.transitionTo('rest')
        break;
      case 'exit':
        studyMachine.transitionTo('survey')
        break;
    }
  }

  if(ds) {
    let space = ds.getSpace()
    try {
      Object.keys(space).forEach((label) => {
        msg += "<b>"+ label+".</b>"
        Object.keys(space[label]).forEach((v) => {
          msg += v + ": " + space[label][v].toFixed(2) + " | "
        })
      })
    }
    catch (err) {
      msg += JSON.stringify(space)
    }
  } else {
    msg = "..."
  }
  printStatus(msg)
}

textbar = document.querySelector(".footer-3")
function printStatus(status) {
  textbar.innerHTML = status
}

window.addEventListener("DOMContentLoaded", function() {
  shortcut.set({
    "f": function () {
      document.querySelector('.footer').classList.remove('hidden')
    }
  })

})

//window.onmousemove = mousemove
//window.ontouchmove = touchmove

</script>

 </body>
</html>
