<!DOCTYPE html>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <head>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
    <link rel="stylesheet" href="../css/style.css"></style>
    <script src="../js/dynam.space.js"></script> 
<style>
div {
 background-color: white;
 color: black;
}
body{
 background-color: white;
}

</style>
  </head>

  <body>
  <div id="main">
  <div id="buttons">
    <button v-show="!info.hasStarted" @click="start">Start</button>
    <button v-show="info.isRunning" @click="stop">Stop</button>
    <button v-show="info.hasStarted && !info.isRunning" @click="reset">Reset</button>
  </div>
  <div id='experiments'>
	  <button v-for="(param, idx) in params" :class="{ active: isActive(param) }" @click="load(param)">
       {{idx}}
    </button>
  </div>
  <div>
  </div>
  <div>
    <canvas id="myCanvas" ref="myCanvas" width="600" height="600"></canvas>
   <template v-if="P.showinfo">
   <br>
   params: { a:{{P.a.toFixed(4)}}, b:{{P.b.toFixed(4)}}, c:{{P.c.toFixed(4)}}, d:{{P.d.toFixed(4)}}, e:{{P.e.toFixed(4)}}, h:{{P.h.toFixed(4)}},
   x1:{{P.x1.toFixed(4)}}, y1:{{P.y1.toFixed(4)}}, x2:{{P.x2.toFixed(4)}}, y2:{{P.y2.toFixed(4)}} }
   <br>
   k_opt: {{P.k_opt}}
   <br>
   l_opt: {{P.l_opt}}
   <br>
   Continous game:
   <br>
   <br>
   minimize f1(x,y), minimize f2(x,y)
   <br>
   &nbsp;&nbsp;
   x
   &nbsp;
   &nbsp;
   &nbsp;
   &nbsp;
   &nbsp;
   &nbsp;
   &nbsp;
   &nbsp;
   y

  <br>
  <br>
  <br>
   Costs:
   <br>
   f1(x,y) = ax<sup>2</sup>/2 + bxy + hy<sup>2</sup>/2
   <br>
   f2(x,y) = ex<sup>2</sup>/2 + cxy + dy<sup>2</sup>/2
   <br>
   <br>
   <br>
   <br>
   Gradients:
   <br>
   <span :style="Math.abs(O.gradstackx) >= Math.abs(O.gradx)? 'color:green' : ''">
   g1(x,y) = ax + by = {{(O.gradx/P.scale).toFixed(2)}}
   </span>
   <br>
   <span :style="Math.abs(O.gradstackx) < Math.abs(O.gradx)? 'color:green' : ''">
   gstack1(x,y) = {{(O.gradstackx/P.scale).toFixed(2)}}
   </span>
   <br>
   <span :style="Math.abs(O.gradstacky) >= Math.abs(O.grady)? 'color:green' : ''">
   g2(x,y) = cx + dy = {{(O.grady/P.scale).toFixed(2)}}
   </span>
   <br>
   <span :style="Math.abs(O.gradstacky) < Math.abs(O.grady)? 'color:green' : ''">
   gstack2(x,y) = {{(O.gradstacky/P.scale).toFixed(2)}}
   </span>
   <br>
   <br>
   Learning Dynamics:
   <br>
   x &lArr;  x -  αg1(x,y)
   <br>
   y &lArr;  y -  βg2(x,y)
   <br>
   <br>
   Game Jacobian:
   <br>
   J(x,y) = ⎡a  b⎤ = ⎡{{P.a.toFixed(1)}}  {{P.b.toFixed(1)}}⎤ 
   <br>
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ⎣c  d⎦ = ⎣{{P.c.toFixed(1)}} {{P.d.toFixed(1)}}⎦
   <br>
   
   <br>
   <br>
   For more info, see papers: 
   <br>
   arXiv:<a href="https://arxiv.org/abs/2011.03650">2011.03650</a> 
   and 
   arXiv:<a href="https://arxiv.org/abs/2011.05562">2011.05562</a> 
   
   </template>
  </div>

  <div>
   <br>
   Noise: 
          <input type='checkbox' v-model="P.usenoise">
          <br>
   Random initialization:
          <input type='checkbox' v-model="P.userandominit">
          <br>
   Machine play smart:
          <input type='checkbox' v-model="P.playconjy">
          <br>
  <template v-if="P.mode!='both'">
  <template v-if="P.mode!='mouse'">
          <br>
   Other play smart:
          <input type='checkbox' v-model="P.playconjx">
          <br>
  </template>
  </template>
          <br>
   Show gradient:
          <input type='checkbox' v-model="P.showcostgradient">
          <br>
   Show curvature:
          <input type='checkbox' v-model="P.showcostcurvature">
          <br>
   Show stack gradient:
          <input type='checkbox' v-model="P.showcoststackgradient">
          <br>
   Show stack curvature:
          <input type='checkbox' v-model="P.showcoststackcurvature">
          <br>
   Show average difference:
          <input type='checkbox' v-model="P.showcostdiff">
          <br>
   Plot learning dynamics:
          <input type='checkbox' v-model="P.history">
          <br>
          <br>
   Show more info:
          <input type='checkbox' v-model="P.showinfo">
          <br>
          <br>
  {{ P.mode=='mouse'?"Minimize your" : "Horizontal player's" }} cost: 
  <br>
  {{O.costx.toFixed(1)}}
  <br>
  <br>
  Vertical  player's cost: 
  <br>
  {{O.costy.toFixed(1)}}
  <br>
  <br>
  <template v-if="P.mode!='both'">
  <template v-if="P.mode!='mouse'">
  Learning rate (x):
  <br>
  <input v-model.number="P.alpha">
  <br>
  <br>
  </template>
  Learning rate (machine):
  <br>
  <input v-model.number="P.beta">
  <br>
  conjectural variation (k,l)
  <br>
  <input v-model.number="P.k">
  <br>
  <input v-model.number="P.l">
  </template>

  <template v-if="P.showinfo">

  <br>
  <!--<button @click="truncate">truncate</button>-->
  <br>


   <br>
   <br>
   More info:
   <br>
   (x,y) = ({{ (S.x/P.scale).toFixed(2) }},{{ (S.y/P.scale).toFixed(2) }})
   <br>
   <br>
   ccve is stable: {{ P.stableccve }}
   <br>
   costs
   <input type="checkbox" v-model="P.showcostx">
   <input type="checkbox" v-model="P.showcosty">
   <br>
   <br>
   nash 
   <input type='checkbox' v-model="P.showg1">: 
   <input type='checkbox' v-model="P.showg2">: 
   <br>
   ({{P.xnash}},{{P.ynash}}) <br>
   <br>
   stack (p1 leader) 
   <input type='checkbox' v-model="P.showgstack1">: 
   <br>
   ({{P.xstack1}},{{P.ystack1}}) <br>
   <br>
   stack (p2 leader) 
   <input type='checkbox' v-model="P.showgstack2">: 
   <br>
   ({{P.xstack2}}, {{P.ystack2}}) <br>
   <br>
   conj  (p1 and p2 leaders)
   <input type='checkbox' v-model="P.showgconj">: 
   <br>
   ({{P.xconj}}, {{P.yconj}})<br>
   <br>
   all iterative conjectures
   <input type='checkbox' v-model="P.showgallconj">: 
   <br>
   <br>
   <br>
   reverse stack 1 <br> (etc)
          <input type='checkbox' v-model="P.showgrevstack1">:
          <br>
   <br>
   reverse stack 2 <br> (etc)
          <input type='checkbox' v-model="P.showgrevstack2">:
          <br>
   <br>
          
   conj11g1 (p1 conj, p2 stack)
   <br> (imp1(imp2(g1)), imp2(g1))
          <input type='checkbox' v-model="P.showgstacktwo">:
          <br>
          ({{P.xstacktwo.toFixed(1)}},{{P.ystacktwo.toFixed(1)}})
   <br>
   <br>
   conj21g2 <br> (imp1(imp2(imp1(g2))), <br> imp2(imp1(g2)))
    
          <input type='checkbox' v-model="P.showgstacktwo1">:
          <br>
          ({{P.xstacktwo.toFixed(1)}},{{P.ystacktwo.toFixed(1)}})
   <br>
   <br>
   conj32g2<br>  (imp1(imp2(imp1(imp2(imp1(g2))))),<br>  imp2(imp1(imp2(imp1(g2)))))
          <input type='checkbox' v-model="P.showgstackthree1">:
          <br>
          ({{P.xstacktwo.toFixed(1)}},{{P.ystacktwo.toFixed(1)}})
   <br>
   <br>
   conj43g2 <br> (etc)
          <input type='checkbox' v-model="P.showgstackfour1">:
          <br>
          ({{P.xstacktwo.toFixed(1)}},{{P.ystacktwo.toFixed(1)}})
   <br>

          <br>
   a: <input v-model.number="P.a">
          <br>
   d: <input v-model.number="P.d">
          <br>
   noise (x): <input v-model.number="P.noisestdx">
          <br>
   noise (y): <input v-model.number="P.noisestdy">
          <br>
          <br>
  </template>
  </div>


  </div>

<script>
const s = (v) => Math.sin(v)
const c = (v) => Math.cos(v)

const experiments = {
  'play': {
    mode: 'mouse',
    edit: false
   },
  'sim': {
    mode: 'simgrad',
   },
  'manual': {
    mode: 'both',
    edit: false
   },
  'edit': {
    edit: true,
   },
  'show all': {
    showinfo: true,
    showcostx: true,
    showcosty: true,
    showinfo: true,
    showg1: true,
    showg2: true,
    showgstack1: true,
    showgstack2: true,
    showgstacktwo1: true,
    showgstackthree1: true,
    showgstackfour1: true,
    showgconj: true,
    showgallconj: true
   }
}


const data = {
  P: { //parameters
    mode: 'mouse',
    edit: false,
    inputmode: 'absolute',//or absolute
    colorcost1: '#C7D8E2',
    colorcost2: '#E8CECC',
    colorx: '#0D5DA3',
    colory: '#910D3C',
    colornash: '#56B336',
    colornash1: '#4694FD',
    colornash2: '#DE3F67',
    colorstack1: '#B87DA8',
    colorstack2: '#92299F',
    colorstacktwo: '#80AB00',
    colorconj: '#8F5400',
    duration: 1000, //seconds
    period: 1/60*1000, //ms
    smooth: 0.95,
    playstackx: false,
    playstacky: false,
    alpha: 0.01,
    beta: 0.01,
    xnash: -1,
    ynash: -1,
    xstack1: 1,
    ystack1: 1,
    xstack2: -0.425,
    ystack2: 0.8503,
    xconj: 0.8493,
    yconj: -0.1495,
    x1: 0,
    x2: 0,
    y1: 0,
    y2: -2,
    a: 1.8,
    b: -.15,
    c: .15,
    d: .7,
    e: 3,
    h: 1,
    k:0, 
    l:0, 
    l_opt:0,
    k_opt:0,
    scale: 40,
    scalecost: 50,
    lvlset: 1,
    history: false,
    showinfo: false,
    showcostx: true,
    showcosty: false,
    showg1: false,
    showg2: false,
    showgstack1: false,
    showgstack2: false,
    showgconj: false,
    showgrevstack1: false,
    showgrevstack2: false,
    showgstacktwo: false,
    showgstacktwo1: false,
    showgstackthree1: false,
    showgstackfour1: false,
    showgallconj: false,
    showcostdiff: false,
    showcostgradient: false,
    showcostcurvature: false,
    userandominit: false,
    usenoise: false,
    noisestdx: 10,
    noisestdy: 10,
    pointradius: 10,
    nash1: null,
    nash2: null,
    stableccve: null
  },
  I: { //inputs
    posX: 0,
    posY: 0,
  },
  O: { //outputs
    time: 0,
    costx: 0,
    costy: 0,
    gradx: 0,
    grady: 0,
    gradstackx: 0,
    gradstacky: 0,
    gradconjx: 0,
    gradconjy: 0
  },
  S: { //state
    time: 0,
    x: 0,
    y: 0,
    xcostsmoothed: 0,
  },
}

 function recompute(P) {
  P.xnash = P.draggables[0].x/P.scale
  P.ynash = P.draggables[0].y/P.scale
  P.xstack1 = P.draggables[1].x/P.scale
  P.ystack1 = P.draggables[1].y/P.scale
  P.xstack2 = P.draggables[2].x/P.scale
  P.ystack2 = P.draggables[2].y/P.scale
  P.xconj = P.draggables[3].x/P.scale
  P.yconj = P.draggables[3].y/P.scale

  const xn = P.xnash
  const yn = P.ynash
  const xs1 = P.xstack1
  const ys1 = P.ystack1
  const xs2 = P.xstack2
  const ys2 = P.ystack2

  const xr = xs1
  const yr = ys1
  const xs = xs2
  const ys = ys2
  const xc = P.xconj
  const yc = P.yconj
  const a = P.a
  const c = P.d
  const h = P.h
  const e = P.e
 

  P.x1 = (xn*xs1*yc - xs1*xs2*yc - xc*xs2*yn + xs1*xs2*yn - xc*xn*ys1 + xc*xs2*ys1 + xc*xn*ys2 - xn*xs1*ys2)/
    (xn*yc - xs2*yc - xc*yn + xs1*yn - xn*ys1 + xs2*ys1 + xc*ys2 - xs1*ys2)
  P.x2 = (xn*xs2*yc - xs1*xs2*yc - xc*xs1*yn + xs1*xs2*yn + xc*xn*ys1 - xn*xs2*ys1 - xc*xn*ys2 + xc*xs1*ys2)/
    (xn*yc - xs1*yc - xc*yn + xs2*yn + xc*ys1 - xs2*ys1 - xn*ys2 + xs1*ys2) 
  P.y1 = (xs1*yc*yn - xs2*yc*yn - xc*yn*ys1 + xs2*yn*ys1 + xn*yc*ys2 - xs1*yc*ys2 + xc*ys1*ys2 - xn*ys1*ys2)/
    (xn*yc - xs2*yc - xc*yn + xs1*yn - xn*ys1 + xs2*ys1 + xc*ys2 - xs1*ys2)
  P.y2 = (-xs1*yc*yn + xs2*yc*yn + xn*yc*ys1 - xs2*yc*ys1 - xc*yn*ys2 + xs1*yn*ys2 + xc*ys1*ys2 - xn*ys1*ys2)/
    (xn*yc - xs1*yc - xc*yn + xs2*yn + xc*ys1 - xs2*ys1 - xn*ys2 + xs1*ys2)
  P.b = (-a*xn + a*xs2)/(yn - ys2)
  P.c = (-c*yn + c*ys1)/(xn - xs1) 
  P.e = (c*(xs1*yc*yn - xs2*yc*yn + xc*yn*yn - xs2*yn*yn - xn*yc*ys1 + xs2*yc*ys1 - xc*yn*ys1 + xs2*yn*ys1 + xn*yc*ys2 - xs1*yc*ys2 - 
     xc*yn*ys2 - xs1*yn*ys2 + 2*xs2*yn*ys2 + xc*ys1*ys2 + xn*ys1*ys2 - 2*xs2*ys1*ys2 - xn*ys2*ys2 + xs1*ys2*ys2))/((xn - 
     xs1)*(xc - xs2)*(xn - xs2))

  disc = 4*(P.a*P.c-P.b*P.e)*(P.c*P.h-P.b*P.d)+(P.a*P.d-P.e*P.h)**2
  linf = (P.a*P.d - P.e*P.h - Math.sqrt(disc))/(2*P.b*P.e-2*P.a*P.c)
  kinf = (P.a*P.d - P.e*P.h - Math.sqrt(disc))/(2*P.c*P.h-2*P.d*P.b)

  Jinf = [[P.a + P.b*kinf, P.b + P.h*kinf],[P.c + P.e*linf, P.d + P.e*linf]]
  trace = Jinf[0][0] + Jinf[1][1]
  det = Jinf[0][0]*Jinf[1][1] - Jinf[1][0]*Jinf[0][1]
    P.stableccve = (trace > 0) && (det > 0)



  P.h = (a*(xn*xn*yc - xn*xs1*yc - xn*xs2*yc + xs1*xs2*yc + xc*xs1*yn -
     xs1*xs1*yn - xc*xs2*yn + xs1*xs2*yn - xc*xn*ys1 - xn*xn*ys1 +
     2*xn*xs1*ys1 + xc*xs2*ys1 + xn*xs2*ys1 - 2*xs1*xs2*ys1 +
     xc*xn*ys2 - xc*xs1*ys2 - xn*xs1*ys2 + xs1*xs1*ys2))/((yc -
     ys1)*(yn - ys1)*(yn - ys2))


   P.xstacktwo = (xn**2*xs*(yc - yr)*(yc - ys)**2 + xc*xr**2*(yc - ys)**2*(-yn + ys) - 
      xs*(yn - yr)*(xs**2*(yc - yn)*(yc - yr) + 
      2*xc*xs*(yc - yr)*(yn - ys) + 
           xc**2*(yn*yr + yc*(-yn + yr) - 2*yr*ys + ys**2)) - 
      xn*(yc - ys)*(xs**2*(yc - yr)*(yc - 2*yn + yr) + 
      2*xc*xs*(yc - yr)*(yn - ys) + 
           xc**2*(yr - ys)**2 + 
      xr*(yc - ys)*(xs*(yc - yr) + xc*(-yr + ys))) + 
      xr*(yc - ys)*(xs**2*(yc - yn)*(yc - yr) + 
      xc**2*(yn - ys)*(yr - ys) - 
      xc*xs*(2*yn*yr + yn*ys - 3*yr*ys + yc*(-3*yn + yr + 2*ys))))/ ((xn)**2*(yc - yr)*(yc - ys)**2 + xr*(xs*(yc + yn - 2*yr) + xc*(yn - ys))*(yc - ys)**2 + 
        xr**2*(yc - ys)**2*(-yn + ys) 
        + (yn - yr)*(
          (-(xs)*(xs))*(yc - yr)*
          (2*yc - yn - ys) + 
           xc**2*(yc - yr)*(yn - ys) + 
      xc*xs*(yc**2 + 2*yn*yr - 2*yc*(yn + yr - ys) - ys**2)) - 
      xn*(yc - ys)*(xs*(yc - yr)*(yc - 2*yn + 2*yr - ys) + 
      xr*(yc - ys)*(yc - 2*yr + ys) - 
      xc*(2*yn*yr - 2*yr**2 + yr*ys - ys**2 + yc*(-2*yn + yr + ys))))

   P.ystacktwo = ((-xc)*xn*yc**2*yr**2 + xn**2*yc**3*ys - 2*xc*xn*yc**2*yn*ys +
   xc**2*yc*yn**2*ys +
      3*xc*xn*yc**2*yr*ys - xn**2*yc**2*yr*ys - xc**2*yc*yn*yr*ys +
   2*xc*xn*yc*yn*yr*ys -
      xc**2*yn**2*yr*ys + xc**2*yn*yr**2*ys - 2*xn**2*yc**2*ys**2 -
   xc**2*yc*yn*ys**2 +
      2*xc*xn*yc*yn*ys**2 + xc**2*yc*yr*ys**2 - 4*xc*xn*yc*yr*ys**2 +
   2*xn**2*yc*yr*ys**2 +
      xc**2*yn*yr*ys**2 - 2*xc*xn*yn*yr*ys**2 - xc**2*yr**2*ys**2 +
   xc*xn*yr**2*ys**2 +
      xn**2*yc*ys**3 + xc*xn*yr*ys**3 - xn**2*yr*ys**3 +
   xr**2*yc*(yc - ys)**2*(-yn + ys) +
      xs**2*(yc - yr)*(-yn + yr)*(yc**2 - yn*ys) -
   xn*xs*(yc - yr)*(yc - ys)*
        (yc*yr + (-2*yn + yr)*ys) -
   xc*xs*(yn - yr)*(yc**2*(yr - 2*ys) + 2*yc*yn*ys +
           yr*ys*(-2*yn + ys)) +
   xr*(yc - ys)**2*(xs*(2*yc*yn - yc*yr - yn*yr) +
           xc*yr*(yn - ys) + xn*(yc*yr - 2*yc*ys + yr*ys)))/
   (xn**2*(yc - yr)*(yc - ys)**2 +
   xr*(xs*(yc + yn - 2*yr) + xc*(yn - ys))*(yc - ys)**2 +
      xr**2*(yc - ys)**2*(-yn + ys) + (yn -
      yr)*((-xs*xs)*(yc - yr)*(2*yc - yn - ys) +
           xc**2*(yc - yr)*(yn - ys) +
      xc*xs*(yc**2 + 2*yn*yr - 2*yc*(yn + yr - ys) - ys**2)) -
      xn*(yc - ys)*(xs*(yc - yr)*(yc - 2*yn + 2*yr - ys) +
      xr*(yc - ys)*(yc - 2*yr + ys) -
      xc*(2*yn*yr - 2*yr**2 + yr*ys - ys**2 + yc*(-2*yn + yr + ys))))


   const b1 = P.b
   const b2 = P.c
   const x1 = P.x1
   const x2 = P.x2
   const y1 = P.y1
   const y2 = P.y2


   P.xstacktwo1 = 
    (a**3*c**4*x1 + b2**2*e*h**3*(e*x2 + b2*(-y1 + y2)) +
      a**2*b2*c**2*h*(b2*(2*x1 + x2) + c*(-y1 + y2)) - 2*b1**3*b2*c*(b2**2*(x1 + x2) + c*e*(x1 + x2) +
        2*b2*c*(-y1 + y2)) + a*b2*h**2*(b2**3*x1 + 2*b2*c*e*x2 + b2**2*c*(-y1 + y2) +
        c**2*e*(-y1 + y2)) - b1*(a**2*c**3*(b2*(5*x1 + x2) + c*(-y1 + y2)) +
        b2*h**2*(2*c*e**2*x2 + b2**2*e*(x1 + 3*x2) - 2*b2**3*(y1 - y2) + 3*b2*c*e*(-y1 + y2)) +
        a*c*h*(b2*c*e*(x1 + 3*x2) + b2**3*(5*x1 + 3*x2) + 5*b2**2*c*(-y1 + y2) + c**2*e*(-y1 + y2))) +
      b1**2*(a*c**2*(c*e*(x1 + x2) + b2**2*(7*x1 + 3*x2) + 4*b2*c*(-y1 + y2)) +
        h*(c**2*e**2*x2 + b2**4*(x1 + 2*x2) + b2**2*c*e*(3*x1 + 5*x2) + 6*b2**3*c*(-y1 + y2) +
          2*b2*c**2*e*(-y1 + y2))))/(a**3*c**4 - 4*b1**3*b2*c*(b2**2 + c*e) + 3*a**2*b2**2*c**2*h +
      a*b2**2*(b2**2 + 2*c*e)*h**2 + b2**2*e**2*h**3 + b1**2*(2*a*c**2*(5*b2**2 + c*e) +
        (3*b2**4 + 8*b2**2*c*e + c**2*e**2)*h) - 2*b1*b2*(3*a**2*c**3 + 2*a*c*(2*b2**2 + c*e)*h +
        e*(2*b2**2 + c*e)*h**2))

   P.ystacktwo1 = 
    (b2**2*e**2*h**3*y1 + a*b2**2*h**2*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*y2) +
      a**3*c**3*(b2*(-x1 + x2) + c*y2) + b1**3*(b2**2 + c*e)*(b2**2*(x1 - x2) + c*e*(x1 - x2) -
        2*b2*c*(y1 + y2)) + a**2*b2*c*h*(b2**2*(-x1 + x2) + c*e*(-x1 + x2) + b2*c*(y1 + 2*y2)) +
      b1*((-b2)*e*h**2*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*(3*y1 + y2)) -
        a**2*c**2*(-4*b2**2*(x1 - x2) + c*e*(-x1 + x2) + b2*c*(y1 + 5*y2)) +
        a*b2*h*(b2**3*(x1 - x2) + 5*b2*c*e*(x1 - x2) - c**2*e*(3*y1 + y2) - b2**2*c*(3*y1 + 5*y2))) +
      b1**2*(h*(2*b2**3*e*(-x1 + x2) + 2*b2*c*e**2*(-x1 + x2) + c**2*e**2*y1 + b2**4*(2*y1 + y2) +
          b2**2*c*e*(5*y1 + 3*y2)) + a*c*(-4*b2**3*(x1 - x2) + 4*b2*c*e*(-x1 + x2) + c**2*e*(y1 + y2) +
          b2**2*c*(3*y1 + 7*y2))))/(a**3*c**4 - 4*b1**3*b2*c*(b2**2 + c*e) + 3*a**2*b2**2*c**2*h +
      a*b2**2*(b2**2 + 2*c*e)*h**2 + b2**2*e**2*h**3 + b1**2*(2*a*c**2*(5*b2**2 + c*e) +
        (3*b2**4 + 8*b2**2*c*e + c**2*e**2)*h) - 2*b1*b2*(3*a**2*c**3 + 2*a*c*(2*b2**2 + c*e)*h +
        e*(2*b2**2 + c*e)*h**2))
   
   P.xstackthree1 = 
    (a**5*c**6*x1 + b2**2*e**3*h**5*(e*x2 + b2*(-y1 + y2)) +
      a**4*b2*c**4*h*(b2*(4*x1 + x2) + c*(-y1 + y2)) + a*b2**2*e*h**4*(2*c*e**2*x2 + b2**2*e*(x1 + 2*x2) +
        b2**3*(-y1 + y2) + 3*b2*c*e*(-y1 + y2)) - b1**5*c*(3*b2**2 + c*e)*
       (b2**3*(x1 + x2) + 3*b2*c*e*(x1 + x2) + 3*b2**2*c*(-y1 + y2) + c**2*e*(-y1 + y2)) +
      a**3*b2*c**2*h**2*(2*b2*c*e*(x1 + x2) + 2*b2**3*(2*x1 + x2) + 3*b2**2*c*(-y1 + y2) +
        c**2*e*(-y1 + y2)) + a**2*b2*h**3*(b2**5*x2 + 3*b2*c**2*e**2*x2 + 2*b2**3*c*e*(2*x1 + x2) +
        2*b2**4*c*(-y1 + y2) + 3*b2**2*c**2*e*(-y1 + y2) + c**3*e**2*(-y1 + y2)) -
      b1*(a**4*c**5*(b2*(9*x1 + x2) + c*(-y1 + y2)) + b2*e**2*h**4*(2*c*e**2*x2 + b2**2*e*(x1 + 7*x2) -
          6*b2**3*(y1 - y2) + 3*b2*c*e*(-y1 + y2)) + a**3*c**3*h*(b2*c*e*(5*x1 + 3*x2) +
          b2**3*(23*x1 + 9*x2) - 11*b2**2*c*(y1 - y2) + c**2*e*(-y1 + y2)) +
        a*b2*h**3*(4*c**2*e**3*x2 + b2**4*e*(5*x1 + 7*x2) + b2**2*c*e**2*(7*x1 + 17*x2) -
          2*b2**5*(y1 - y2) - 17*b2**3*c*e*(y1 - y2) + 9*b2*c**2*e**2*(-y1 + y2)) +
        a**2*c*h**2*(2*b2**5*(5*x1 + 4*x2) + b2*c**2*e**2*(x1 + 5*x2) + b2**3*c*e*(19*x1 + 17*x2) -
          16*b2**4*c*(y1 - y2) - 13*b2**2*c**2*e*(y1 - y2) + c**3*e**2*(-y1 + y2))) +
      b1**2*(a**2*c**2*h*(c**2*e**2*(x1 + 2*x2) + b2**2*c*e*(31*x1 + 23*x2) + b2**4*(40*x1 + 23*x2) -
          36*b2**3*c*(y1 - y2) - 12*b2*c**2*e*(y1 - y2)) +
        a**3*c**4*(c*e*(3*x1 + x2) + b2**2*(29*x1 + 7*x2) + 8*b2*c*(-y1 + y2)) +
        e*h**3*(c**2*e**3*x2 + 3*b2**2*c*e**2*(x1 + 5*x2) + b2**4*e*(5*x1 + 16*x2) - 11*b2**5*(y1 - y2) -
          18*b2**3*c*e*(y1 - y2) + 3*b2*c**2*e**2*(-y1 + y2)) +
        a*h**2*(2*c**3*e**3*x2 + b2**6*(6*x1 + 4*x2) + 3*b2**2*c**2*e**2*(5*x1 + 9*x2) +
          3*b2**4*c*e*(9*x1 + 13*x2) - 19*b2**5*c*(y1 - y2) - 46*b2**3*c**2*e*(y1 - y2) +
          7*b2*c**3*e**2*(-y1 + y2))) + b1**4*(a*c**2*(c**2*e**2*(2*x1 + x2) + 6*b2**2*c*e*(4*x1 + 3*x2) +
          b2**4*(22*x1 + 13*x2) - 24*b2**3*c*(y1 - y2) + 8*b2*c**2*e*(-y1 + y2)) +
        h*(c**3*e**3*(x1 + x2) + b2**6*(2*x1 + 3*x2) + 3*b2**2*c**2*e**2*(4*x1 + 7*x2) +
          b2**4*c*e*(17*x1 + 23*x2) - 15*b2**5*c*(y1 - y2) - 26*b2**3*c**2*e*(y1 - y2) +
          7*b2*c**3*e**2*(-y1 + y2))) - b1**3*(2*a**2*c**3*(4*b2*c*e*(2*x1 + x2) + 4*b2**3*(5*x1 + 2*x2) -
          11*b2**2*c*(y1 - y2) + c**2*e*(-y1 + y2)) + a*c*h*(b2*c**2*e**2*(11*x1 + 13*x2) +
          b2**5*(23*x1 + 17*x2) + 2*b2**3*c*e*(23*x1 + 25*x2) - 41*b2**4*c*(y1 - y2) -
          38*b2**2*c**2*e*(y1 - y2) + c**3*e**2*(-y1 + y2)) + h**2*(3*b2*c**2*e**3*(x1 + 3*x2) +
          b2**5*e*(7*x1 + 13*x2) + 2*b2**3*c*e**2*(7*x1 + 17*x2) - 6*b2**6*(y1 - y2) -
          31*b2**4*c*e*(y1 - y2) - 18*b2**2*c**2*e**2*(y1 - y2) + c**3*e**3*(-y1 + y2))))/
     (a**5*c**6 - 2*b1**5*b2*c*(3*b2**4 + 10*b2**2*c*e + 3*c**2*e**2) + 5*a**4*b2**2*c**4*h +
      2*a**3*b2**2*c**2*(3*b2**2 + 2*c*e)*h**2 + a**2*b2**2*(b2**4 + 6*b2**2*c*e + 3*c**2*e**2)*h**3 +
      a*b2**2*e**2*(3*b2**2 + 2*c*e)*h**4 + b2**2*e**4*h**5 +
      b1**4*(a*c**2*(35*b2**4 + 42*b2**2*c*e + 3*c**2*e**2) + (5*b2**6 + 40*b2**4*c*e + 33*b2**2*c**2*e**2 +
          2*c**3*e**3)*h) - 4*b1**3*b2*(2*a**2*c**3*(7*b2**2 + 3*c*e) +
        2*a*c*(5*b2**4 + 12*b2**2*c*e + 3*c**2*e**2)*h + e*(5*b2**4 + 12*b2**2*c*e + 3*c**2*e**2)*h**2) +
      b1**2*(4*a**3*c**4*(9*b2**2 + c*e) + 3*a**2*c**2*(21*b2**4 + 18*b2**2*c*e + c**2*e**2)*h +
        2*a*(5*b2**6 + 33*b2**4*c*e + 21*b2**2*c**2*e**2 + c**3*e**3)*h**2 +
        e**2*(21*b2**4 + 18*b2**2*c*e + c**2*e**2)*h**3) -
      2*b1*b2*(5*a**4*c**5 + 4*a**3*c**3*(4*b2**2 + c*e)*h + 3*a**2*c*(3*b2**4 + 6*b2**2*c*e + c**2*e**2)*
         h**2 + 2*a*e*(3*b2**4 + 6*b2**2*c*e + c**2*e**2)*h**3 + e**3*(4*b2**2 + c*e)*h**4))


   P.ystackthree1 = 
    (b2**2*e**4*h**5*y1 + a**5*c**5*(b2*(-x1 + x2) + c*y2) + b1**5*b2*(b2**2 + 3*c*e)*
       (b2**3*(x1 - x2) + 3*b2*c*e*(x1 - x2) - 3*b2**2*c*(y1 + y2) - c**2*e*(y1 + y2)) +
      a*b2**2*e**2*h**4*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*(2*y1 + y2)) +
      a**3*b2*c*h**2*(-2*b2**4*(x1 - x2) + 3*b2**2*c*e*(-x1 + x2) + c**2*e**2*(-x1 + x2) +
        2*b2*c**2*e*(y1 + y2) + 2*b2**3*c*(y1 + 2*y2)) +
      a**2*b2**2*h**3*(b2**3*e*(-x1 + x2) + 3*b2*c*e**2*(-x1 + x2) + b2**4*y1 + 3*c**2*e**2*y1 +
        2*b2**2*c*e*(y1 + 2*y2)) + a**4*b2*c**3*h*(-3*b2**2*(x1 - x2) + c*e*(-x1 + x2) +
        b2*c*(y1 + 4*y2)) + b1**4*(h*(-20*b2**3*c*e**2*(x1 - x2) + 6*b2**5*e*(-x1 + x2) +
          6*b2*c**2*e**3*(-x1 + x2) + c**3*e**3*(y1 + y2) + b2**6*(3*y1 + 2*y2) +
          3*b2**2*c**2*e**2*(7*y1 + 4*y2) + b2**4*c*e*(23*y1 + 17*y2)) +
        a*c*(-9*b2**5*(x1 - x2) - 30*b2**3*c*e*(x1 - x2) + 9*b2*c**2*e**2*(-x1 + x2) +
          c**3*e**2*(y1 + 2*y2) + 6*b2**2*c**2*e*(3*y1 + 4*y2) + b2**4*c*(13*y1 + 22*y2))) +
      b1*((-b2)*e**3*h**4*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*(7*y1 + y2)) -
        a*b2*e*h**3*(7*b2**3*e*(-x1 + x2) + 5*b2*c*e**2*(-x1 + x2) + 4*c**2*e**2*y1 +
          b2**4*(7*y1 + 5*y2) + b2**2*c*e*(17*y1 + 7*y2)) - a**4*c**4*(-8*b2**2*(x1 - x2) +
          c*e*(-x1 + x2) + b2*c*(y1 + 9*y2)) + a**2*b2*h**2*(3*b2**5*(x1 - x2) +
          15*b2**3*c*e*(x1 - x2) + 12*b2*c**2*e**2*(x1 - x2) - c**3*e**2*(5*y1 + y2) -
          2*b2**4*c*(4*y1 + 5*y2) - b2**2*c**2*e*(17*y1 + 19*y2)) -
        a**3*c**2*h*(-14*b2**4*(x1 - x2) - 13*b2**2*c*e*(x1 - x2) + c**2*e**2*(-x1 + x2) +
          b2*c**2*e*(3*y1 + 5*y2) + b2**3*c*(9*y1 + 23*y2))) +
      b1**3*(-2*a**2*c**2*(-12*b2**4*(x1 - x2) - 15*b2**2*c*e*(x1 - x2) + c**2*e**2*(-x1 + x2) +
          4*b2*c**2*e*(y1 + 2*y2) + 4*b2**3*c*(2*y1 + 5*y2)) +
        e*h**2*(11*b2**4*e*(x1 - x2) + 12*b2**2*c*e**2*(x1 - x2) + c**2*e**3*(x1 - x2) -
          3*b2*c**2*e**2*(3*y1 + y2) - b2**5*(13*y1 + 7*y2) - 2*b2**3*c*e*(17*y1 + 7*y2)) +
        a*h*(4*b2**6*(x1 - x2) + 43*b2**4*c*e*(x1 - x2) + 30*b2**2*c**2*e**2*(x1 - x2) +
          3*c**3*e**3*(x1 - x2) - b2*c**3*e**2*(13*y1 + 11*y2) - b2**5*c*(17*y1 + 23*y2) -
          2*b2**3*c**2*e*(25*y1 + 23*y2))) +
      b1**2*(e**2*h**3*(6*b2**3*e*(-x1 + x2) + 2*b2*c*e**2*(-x1 + x2) + c**2*e**2*y1 +
          3*b2**2*c*e*(5*y1 + y2) + b2**4*(16*y1 + 5*y2)) + a*h**2*(-13*b2**5*e*(x1 - x2) -
          28*b2**3*c*e**2*(x1 - x2) + 7*b2*c**2*e**3*(-x1 + x2) + 2*c**3*e**3*y1 +
          3*b2**2*c**2*e**2*(9*y1 + 5*y2) + b2**6*(4*y1 + 6*y2) + 3*b2**4*c*e*(13*y1 + 9*y2)) +
        a**3*c**3*(-22*b2**3*(x1 - x2) - 10*b2*c*e*(x1 - x2) + c**2*e*(y1 + 3*y2) +
          b2**2*c*(7*y1 + 29*y2)) + a**2*c*h*(-17*b2**5*(x1 - x2) - 44*b2**3*c*e*(x1 - x2) -
          11*b2*c**2*e**2*(x1 - x2) + c**3*e**2*(2*y1 + y2) + b2**2*c**2*e*(23*y1 + 31*y2) +
          b2**4*c*(23*y1 + 40*y2))))/(a**5*c**6 - 2*b1**5*b2*c*(3*b2**4 + 10*b2**2*c*e + 3*c**2*e**2) +
      5*a**4*b2**2*c**4*h + 2*a**3*b2**2*c**2*(3*b2**2 + 2*c*e)*h**2 +
      a**2*b2**2*(b2**4 + 6*b2**2*c*e + 3*c**2*e**2)*h**3 + a*b2**2*e**2*(3*b2**2 + 2*c*e)*h**4 +
      b2**2*e**4*h**5 + b1**4*(a*c**2*(35*b2**4 + 42*b2**2*c*e + 3*c**2*e**2) +
        (5*b2**6 + 40*b2**4*c*e + 33*b2**2*c**2*e**2 + 2*c**3*e**3)*h) -
      4*b1**3*b2*(2*a**2*c**3*(7*b2**2 + 3*c*e) + 2*a*c*(5*b2**4 + 12*b2**2*c*e + 3*c**2*e**2)*h +
        e*(5*b2**4 + 12*b2**2*c*e + 3*c**2*e**2)*h**2) + b1**2*(4*a**3*c**4*(9*b2**2 + c*e) +
        3*a**2*c**2*(21*b2**4 + 18*b2**2*c*e + c**2*e**2)*h + 2*a*(5*b2**6 + 33*b2**4*c*e +
          21*b2**2*c**2*e**2 + c**3*e**3)*h**2 + e**2*(21*b2**4 + 18*b2**2*c*e + c**2*e**2)*h**3) -
      2*b1*b2*(5*a**4*c**5 + 4*a**3*c**3*(4*b2**2 + c*e)*h + 3*a**2*c*(3*b2**4 + 6*b2**2*c*e + c**2*e**2)*
         h**2 + 2*a*e*(3*b2**4 + 6*b2**2*c*e + c**2*e**2)*h**3 + e**3*(4*b2**2 + c*e)*h**4))


   P.xstackfour1 = 
(a**7*c**8*x1 + b1**4*(a**3*c**4*(22*b2**2*c*e*(7*x1 + 3*x2) + c**2*e**2*(7*x1 + 3*x2) + 
          b2**4*(239*x1 + 91*x2) - 128*b2**3*c*(y1 - y2) - 32*b2*c**2*e*(y1 - y2)) + 
        a**2*c**2*h*(c**3*e**3*(7*x1 + 5*x2) + 6*b2**6*(38*x1 + 25*x2) + 2*b2**2*c**2*e**2*(95*x1 + 82*x2) + 
          b2**4*c*e*(535*x1 + 401*x2) - 306*b2**5*c*(y1 - y2) - 364*b2**3*c**2*e*(y1 - y2) - 
          50*b2*c**3*e**2*(y1 - y2)) + e*h**3*(c**3*e**4*(x1 + 3*x2) + 2*b2**2*c**2*e**3*(15*x1 + 44*x2) + 
          b2**6*e*(40*x1 + 86*x2) + b2**4*c*e**2*(89*x1 + 223*x2) - 46*b2**7*(y1 - y2) - 
          196*b2**5*c*e*(y1 - y2) - 142*b2**3*c**2*e**2*(y1 - y2) - 16*b2*c**3*e**3*(y1 - y2)) + 
        a*h**2*(c**4*e**4*(4*x1 + 5*x2) + b2**8*(19*x1 + 16*x2) + 4*b2**6*c*e*(54*x1 + 65*x2) + 
          2*b2**2*c**3*e**3*(55*x1 + 89*x2) + b2**4*c**2*e**2*(371*x1 + 501*x2) - 94*b2**7*c*(y1 - y2) - 
          478*b2**5*c**2*e*(y1 - y2) - 346*b2**3*c**3*e**2*(y1 - y2) - 42*b2*c**4*e**3*(y1 - y2))) + 
      b2**2*e**5*h**7*(e*x2 + b2*(-y1 + y2)) + a**6*b2*c**6*h*(b2*(6*x1 + x2) + c*(-y1 + y2)) + 
      a*b2**2*e**3*h**6*(2*c*e**2*x2 + b2**2*e*(x1 + 4*x2) - 3*b2**3*(y1 - y2) + 3*b2*c*e*(-y1 + y2)) + 
      a**5*b2*c**4*h**2*(2*b2*c*e*(2*x1 + x2) + b2**3*(11*x1 + 4*x2) + 5*b2**2*c*(-y1 + y2) + 
        c**2*e*(-y1 + y2)) - 4*b1**7*b2*c*(b2**2 + c*e)*(b2**4*(x1 + x2) + 6*b2**2*c*e*(x1 + x2) + 
        c**2*e**2*(x1 + x2) + 4*b2**3*c*(-y1 + y2) + 4*b2*c**2*e*(-y1 + y2)) + 
      a**2*b2**2*e*h**5*(3*c**2*e**3*x2 + 2*b2**4*e*(x1 + 2*x2) + 4*b2**2*c*e**2*(x1 + 2*x2) - 
        2*b2**5*(y1 - y2) + 7*b2**3*c*e*(-y1 + y2) + 6*b2*c**2*e**2*(-y1 + y2)) + 
      a**4*b2*c**2*h**3*(4*b2**3*c*e*(3*x1 + 2*x2) + b2*c**2*e**2*(2*x1 + 3*x2) + b2**5*(6*x1 + 4*x2) + 
        7*b2**4*c*(-y1 + y2) + 7*b2**2*c**2*e*(-y1 + y2) + c**3*e**2*(-y1 + y2)) + 
      a**3*b2*h**4*(b2**7*x1 + 4*b2*c**3*e**3*x2 + 4*b2**5*c*e*(x1 + 2*x2) + 
        2*b2**3*c**2*e**2*(5*x1 + 4*x2) - 11*b2**4*c**2*e*(y1 - y2) + 2*b2**6*c*(-y1 + y2) + 
        6*b2**2*c**3*e**2*(-y1 + y2) + c**4*e**3*(-y1 + y2)) + 
      b1**6*(h*(c**4*e**4*(x1 + 2*x2) + b2**8*(3*x1 + 4*x2) + 2*b2**2*c**3*e**3*(19*x1 + 25*x2) + 
          2*b2**6*c*e*(25*x1 + 31*x2) + 2*b2**4*c**2*e**2*(50*x1 + 69*x2) - 28*b2**7*c*(y1 - y2) - 
          116*b2**5*c**2*e*(y1 - y2) - 100*b2**3*c**3*e**2*(y1 - y2) - 12*b2*c**4*e**3*(y1 - y2)) + 
        2*a*c**2*(c**3*e**3*(x1 + x2) + b2**6*(25*x1 + 17*x2) + b2**2*c**2*e**2*(31*x1 + 23*x2) + 
          b2**4*c*e*(71*x1 + 55*x2) - 40*b2**5*c*(y1 - y2) - 48*b2**3*c**2*e*(y1 - y2) + 
          8*b2*c**3*e**2*(-y1 + y2))) + b1**2*(a**5*c**6*(c*e*(5*x1 + x2) + b2**2*(67*x1 + 11*x2) - 
          12*b2*c*(y1 - y2)) + a**4*c**4*h*(c**2*e**2*(3*x1 + 2*x2) + 25*b2**4*(8*x1 + 3*x2) + 
          b2**2*c*e*(97*x1 + 43*x2) - 98*b2**3*c*(y1 - y2) - 22*b2*c**2*e*(y1 - y2)) + 
        a**3*c**2*h**2*(c**3*e**3*(x1 + 3*x2) + 12*b2**6*(11*x1 + 7*x2) + 4*b2**2*c**2*e**2*(19*x1 + 18*x2) + 
          b2**4*c*e*(271*x1 + 201*x2) - 159*b2**5*c*(y1 - y2) - 178*b2**3*c**2*e*(y1 - y2) - 
          23*b2*c**3*e**2*(y1 - y2)) + a**2*h**3*(3*c**4*e**4*x2 + 3*b2**8*(3*x1 + 4*x2) + 
          6*b2**2*c**3*e**3*(7*x1 + 13*x2) + 2*b2**6*c*e*(65*x1 + 67*x2) + 
          b2**4*c**2*e**2*(179*x1 + 253*x2) - 52*b2**7*c*(y1 - y2) - 235*b2**5*c**2*e*(y1 - y2) - 
          178*b2**3*c**3*e**2*(y1 - y2) - 15*b2*c**4*e**3*(y1 - y2)) + 
        e**3*h**5*(c**2*e**3*x2 + b2**2*c*e**2*(3*x1 + 25*x2) + b2**4*e*(9*x1 + 46*x2) - 
          37*b2**5*(y1 - y2) - 32*b2**3*c*e*(y1 - y2) + 3*b2*c**2*e**2*(-y1 + y2)) + 
        a*e*h**4*(2*c**3*e**4*x2 + b2**2*c**2*e**3*(15*x1 + 59*x2) + b2**6*e*(38*x1 + 70*x2) + 
          b2**4*c*e**2*(67*x1 + 169*x2) - 32*b2**7*(y1 - y2) - 157*b2**5*c*e*(y1 - y2) - 
          102*b2**3*c**2*e**2*(y1 - y2) + 9*b2*c**3*e**3*(-y1 + y2))) - 
      b1*(a**2*b2*h**4*(6*c**3*e**4*x2 + 2*b2**6*e*(5*x1 + 7*x2) + 2*b2**2*c**2*e**3*(11*x1 + 25*x2) + 
          b2**4*c*e**2*(43*x1 + 65*x2) - 4*b2**7*(y1 - y2) - 42*b2**5*c*e*(y1 - y2) - 
          71*b2**3*c**2*e**2*(y1 - y2) - 18*b2*c**3*e**3*(y1 - y2)) + 
        a**6*c**7*(b2*(13*x1 + x2) + c*(-y1 + y2)) + b2*e**4*h**6*(2*c*e**2*x2 + b2**2*e*(x1 + 11*x2) - 
          10*b2**3*(y1 - y2) + 3*b2*c*e*(-y1 + y2)) + a**5*c**5*h*(3*b2*c*e*(3*x1 + x2) + 
          3*b2**3*(19*x1 + 5*x2) - 17*b2**2*c*(y1 - y2) + c**2*e*(-y1 + y2)) + 
        a*b2*e**2*h**5*(4*c**2*e**3*x2 + b2**4*e*(11*x1 + 29*x2) + b2**2*c*e**2*(7*x1 + 33*x2) - 
          18*b2**5*(y1 - y2) - 39*b2**3*c*e*(y1 - y2) + 9*b2*c**2*e**2*(-y1 + y2)) + 
        a**4*c**3*h**2*(5*b2*c**2*e**2*(x1 + x2) + b2**5*(67*x1 + 33*x2) + b2**3*c*e*(63*x1 + 37*x2) - 
          49*b2**4*c*(y1 - y2) - 25*b2**2*c**2*e*(y1 - y2) + c**3*e**2*(-y1 + y2)) + 
        a**3*c*h**3*(b2*c**3*e**3*(x1 + 7*x2) + 2*b2**7*(9*x1 + 7*x2) + 3*b2**5*c*e*(25*x1 + 23*x2) + 
          2*b2**3*c**2*e**2*(23*x1 + 25*x2) - 36*b2**6*c*(y1 - y2) - 79*b2**4*c**2*e*(y1 - y2) - 
          24*b2**2*c**3*e**2*(y1 - y2) + c**4*e**3*(-y1 + y2))) - 
      2*b1**5*(a**2*c**3*(6*b2**3*c*e*(19*x1 + 11*x2) + b2*c**2*e**2*(19*x1 + 11*x2) + 
          b2**5*(83*x1 + 43*x2) - 74*b2**4*c*(y1 - y2) - 44*b2**2*c**2*e*(y1 - y2) + 
          2*c**3*e**2*(-y1 + y2)) + a*c*h*(b2*c**3*e**3*(17*x1 + 19*x2) + b2**7*(31*x1 + 25*x2) + 
          b2**3*c**2*e**2*(133*x1 + 139*x2) + b2**5*c*e*(155*x1 + 153*x2) - 79*b2**6*c*(y1 - y2) - 
          189*b2**4*c**2*e*(y1 - y2) - 65*b2**2*c**3*e**2*(y1 - y2) + 3*c**4*e**3*(-y1 + y2)) + 
        h**2*(6*b2*c**3*e**4*(x1 + 2*x2) + 14*b2**5*c*e**2*(4*x1 + 7*x2) + b2**7*e*(11*x1 + 17*x2) + 
          b2**3*c**2*e**3*(47*x1 + 89*x2) - 6*b2**8*(y1 - y2) - 65*b2**6*c*e*(y1 - y2) - 
          109*b2**4*c**2*e**2*(y1 - y2) - 35*b2**2*c**3*e**3*(y1 - y2) + c**4*e**4*(-y1 + y2))) - 
      b1**3*(2*a**4*c**5*(b2*c*e*(23*x1 + 7*x2) + b2**3*(87*x1 + 23*x2) - 28*b2**2*c*(y1 - y2) + 
          2*c**2*e*(-y1 + y2)) + a**3*c**3*h*(b2*c**2*e**2*(47*x1 + 33*x2) + 
          2*b2**3*c*e*(177*x1 + 103*x2) + b2**5*(319*x1 + 161*x2) - 253*b2**4*c*(y1 - y2) - 
          142*b2**2*c**2*e*(y1 - y2) + 5*c**3*e**2*(-y1 + y2)) + 
        e**2*h**4*(28*b2**3*c*e**2*(x1 + 4*x2) + b2*c**2*e**3*(3*x1 + 17*x2) + b2**5*e*(29*x1 + 91*x2) - 
          62*b2**6*(y1 - y2) - 121*b2**4*c*e*(y1 - y2) - 36*b2**2*c**2*e**2*(y1 - y2) + 
          c**3*e**3*(-y1 + y2)) + a**2*c*h**2*(b2*c**3*e**3*(31*x1 + 41*x2) + b2**7*(92*x1 + 76*x2) + 
          2*b2**3*c**2*e**2*(145*x1 + 167*x2) + b2**5*c*e*(427*x1 + 389*x2) - 206*b2**6*c*(y1 - y2) - 
          471*b2**4*c**2*e*(y1 - y2) - 160*b2**2*c**3*e**2*(y1 - y2) + 3*c**4*e**3*(-y1 + y2)) + 
        a*h**3*(16*b2**7*e*(3*x1 + 4*x2) + b2*c**3*e**4*(13*x1 + 35*x2) + 
          2*b2**3*c**2*e**3*(67*x1 + 141*x2) + b2**5*c*e**2*(205*x1 + 339*x2) - 16*b2**8*(y1 - y2) - 
          228*b2**6*c*e*(y1 - y2) - 371*b2**4*c**2*e**2*(y1 - y2) - 102*b2**2*c**3*e**3*(y1 - y2) + 
          3*c**4*e**4*(-y1 + y2))))/(a**7*c**8 - 8*b1**7*b2*c*(b2**6 + 7*b2**4*c*e + 7*b2**2*c**2*e**2 + 
        c**3*e**3) + 7*a**6*b2**2*c**6*h + 3*a**5*b2**2*c**4*(5*b2**2 + 2*c*e)*h**2 + 
      5*a**4*b2**2*c**2*(2*b2**4 + 4*b2**2*c*e + c**2*e**2)*h**3 + 
      a**3*b2**2*(b2**6 + 12*b2**4*c*e + 18*b2**2*c**2*e**2 + 4*c**3*e**3)*h**4 + 
      3*a**2*b2**2*e**2*(2*b2**4 + 4*b2**2*c*e + c**2*e**2)*h**5 + a*b2**2*e**4*(5*b2**2 + 2*c*e)*h**6 + 
      b2**2*e**6*h**7 + b1**6*(4*a*c**2*(21*b2**6 + 63*b2**4*c*e + 27*b2**2*c**2*e**2 + c**3*e**3) + 
        (7*b2**8 + 112*b2**6*c*e + 238*b2**4*c**2*e**2 + 88*b2**2*c**3*e**3 + 3*c**4*e**4)*h) - 
      4*b1**5*b2*(3*a**2*c**3*(21*b2**4 + 30*b2**2*c*e + 5*c**2*e**2) + 
        2*a*c*(14*b2**6 + 77*b2**4*c*e + 68*b2**2*c**2*e**2 + 9*c**3*e**3)*h + 
        e*(14*b2**6 + 77*b2**4*c*e + 68*b2**2*c**2*e**2 + 9*c**3*e**3)*h**2) + 
      b1**4*(10*a**3*c**4*(33*b2**4 + 22*b2**2*c*e + c**2*e**2) + 6*a**2*c**2*(63*b2**6 + 156*b2**4*c*e + 
          59*b2**2*c**2*e**2 + 2*c**3*e**3)*h + a*(35*b2**8 + 476*b2**6*c*e + 872*b2**4*c**2*e**2 + 
          288*b2**2*c**3*e**3 + 9*c**4*e**4)*h**2 + 2*e**2*(63*b2**6 + 156*b2**4*c*e + 59*b2**2*c**2*e**2 + 
          2*c**3*e**3)*h**3) - 4*b1**3*b2*(5*a**4*c**5*(11*b2**2 + 3*c*e) + 
        20*a**3*c**3*(6*b2**4 + 7*b2**2*c*e + c**2*e**2)*h + 6*a**2*c*(7*b2**6 + 34*b2**4*c*e + 
          26*b2**2*c**2*e**2 + 3*c**3*e**3)*h**2 + 4*a*e*(7*b2**6 + 34*b2**4*c*e + 26*b2**2*c**2*e**2 + 
          3*c**3*e**3)*h**3 + 5*e**3*(6*b2**4 + 7*b2**2*c*e + c**2*e**2)*h**4) + 
      b1**2*(6*a**5*c**6*(13*b2**2 + c*e) + 5*a**4*c**4*(55*b2**4 + 28*b2**2*c*e + c**2*e**2)*h + 
        4*a**3*c**2*(54*b2**6 + 118*b2**4*c*e + 37*b2**2*c**2*e**2 + c**3*e**3)*h**2 + 
        3*a**2*(7*b2**8 + 88*b2**6*c*e + 144*b2**4*c**2*e**2 + 40*b2**2*c**3*e**3 + c**4*e**4)*h**3 + 
        2*a*e**2*(54*b2**6 + 118*b2**4*c*e + 37*b2**2*c**2*e**2 + c**3*e**3)*h**4 + 
        e**4*(55*b2**4 + 28*b2**2*c*e + c**2*e**2)*h**5) - 
      2*b1*b2*(7*a**6*c**7 + 6*a**5*c**5*(6*b2**2 + c*e)*h + 5*a**4*c**3*(10*b2**4 + 10*b2**2*c*e + c**2*e**2)*
         h**2 + 4*a**3*c*(4*b2**6 + 18*b2**4*c*e + 12*b2**2*c**2*e**2 + c**3*e**3)*h**3 + 
        3*a**2*e*(4*b2**6 + 18*b2**4*c*e + 12*b2**2*c**2*e**2 + c**3*e**3)*h**4 + 
        2*a*e**3*(10*b2**4 + 10*b2**2*c*e + c**2*e**2)*h**5 + e**5*(6*b2**2 + c*e)*h**6))

  P.ystackfour1 = 
  (b2**2*e**6*h**7*y1 + a**7*c**7*(b2*(-x1 + x2) + c*y2) + b1**7*(b2**4 + 6*b2**2*c*e + c**2*e**2)*
       (b2**4*(x1 - x2) + 6*b2**2*c*e*(x1 - x2) + c**2*e**2*(x1 - x2) - 4*b2**3*c*(y1 + y2) -
        4*b2*c**2*e*(y1 + y2)) + a**2*b2**2*e**2*h**5*(3*b2**3*e*(-x1 + x2) + 3*b2*c*e**2*(-x1 + x2) +
        3*c**2*e**2*y1 + 2*b2**4*(2*y1 + y2) + 4*b2**2*c*e*(2*y1 + y2)) +
      a*b2**2*e**4*h**6*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*(4*y1 + y2)) +
      a**3*b2**2*h**4*(2*b2**5*e*(-x1 + x2) + 7*b2**3*c*e**2*(-x1 + x2) + 6*b2*c**2*e**3*(-x1 + x2) +
        4*c**3*e**3*y1 + b2**6*y2 + 4*b2**4*c*e*(2*y1 + y2) + 2*b2**2*c**2*e**2*(4*y1 + 5*y2)) +
      a**6*b2*c**5*h*(-5*b2**2*(x1 - x2) + c*e*(-x1 + x2) + b2*c*(y1 + 6*y2)) +
      a**4*b2*c*h**3*(-2*b2**6*(x1 - x2) - 11*b2**4*c*e*(x1 - x2) + 6*b2**2*c**2*e**2*(-x1 + x2) +
        c**3*e**3*(-x1 + x2) + b2*c**3*e**2*(3*y1 + 2*y2) + 4*b2**3*c**2*e*(2*y1 + 3*y2) +
        b2**5*c*(4*y1 + 6*y2)) + a**5*b2*c**3*h**2*(-7*b2**4*(x1 - x2) + 7*b2**2*c*e*(-x1 + x2) +
        c**2*e**2*(-x1 + x2) + 2*b2*c**2*e*(y1 + 2*y2) + b2**3*c*(4*y1 + 11*y2)) +
      b1*((-b2)*e**5*h**6*(b2*e*(-x1 + x2) + 2*c*e*y1 + b2**2*(11*y1 + y2)) -
        a*b2*e**3*h**5*(-13*b2**3*e*(x1 - x2) + 5*b2*c*e**2*(-x1 + x2) + 4*c**2*e**2*y1 +
          b2**2*c*e*(33*y1 + 7*y2) + b2**4*(29*y1 + 11*y2)) -
        a**6*c**6*(-12*b2**2*(x1 - x2) + c*e*(-x1 + x2) + b2*c*(y1 + 13*y2)) -
        a**5*c**4*h*(-42*b2**4*(x1 - x2) - 23*b2**2*c*e*(x1 - x2) + c**2*e**2*(-x1 + x2) +
          3*b2*c**2*e*(y1 + 3*y2) + 3*b2**3*c*(5*y1 + 19*y2)) +
        a**3*b2*h**3*(3*b2**7*(x1 - x2) + 46*b2**5*c*e*(x1 - x2) + 69*b2**3*c**2*e**2*(x1 - x2) +
          22*b2*c**3*e**3*(x1 - x2) - c**4*e**3*(7*y1 + y2) - 2*b2**6*c*(7*y1 + 9*y2) -
          2*b2**2*c**3*e**2*(25*y1 + 23*y2) - 3*b2**4*c**2*e*(23*y1 + 25*y2)) -
        a**2*b2*e*h**4*(-20*b2**5*e*(x1 - x2) - 43*b2**3*c*e**2*(x1 - x2) - 12*b2*c**2*e**3*(x1 - x2) +
          6*c**3*e**3*y1 + 2*b2**6*(7*y1 + 5*y2) + 2*b2**2*c**2*e**2*(25*y1 + 11*y2) +
          b2**4*c*e*(65*y1 + 43*y2)) - a**4*c**2*h**2*(-34*b2**6*(x1 - x2) - 75*b2**4*c*e*(x1 - x2) -
          25*b2**2*c**2*e**2*(x1 - x2) + c**3*e**3*(-x1 + x2) + 5*b2*c**3*e**2*(y1 + y2) +
          b2**3*c**2*e*(37*y1 + 63*y2) + b2**5*c*(33*y1 + 67*y2))) +
      b1**6*(h*(-12*b2**7*e*(x1 - x2) - 84*b2**5*c*e**2*(x1 - x2) - 84*b2**3*c**2*e**3*(x1 - x2) -
          12*b2*c**3*e**4*(x1 - x2) + c**4*e**4*(2*y1 + y2) + b2**8*(4*y1 + 3*y2) +
          2*b2**2*c**3*e**3*(25*y1 + 19*y2) + 2*b2**6*c*e*(31*y1 + 25*y2) +
          2*b2**4*c**2*e**2*(69*y1 + 50*y2)) + 2*a*c*(-8*b2**7*(x1 - x2) - 56*b2**5*c*e*(x1 - x2) -
          56*b2**3*c**2*e**2*(x1 - x2) + 8*b2*c**3*e**3*(-x1 + x2) + c**4*e**3*(y1 + y2) +
          b2**6*c*(17*y1 + 25*y2) + b2**2*c**3*e**2*(23*y1 + 31*y2) + b2**4*c**2*e*(55*y1 + 71*y2))) +
      b1**5*(-2*e*h**2*(-23*b2**6*e*(x1 - x2) - 67*b2**4*c*e**2*(x1 - x2) - 29*b2**2*c**2*e**3*(x1 - x2) +
          c**3*e**4*(-x1 + x2) + 6*b2*c**3*e**3*(2*y1 + y2) + 14*b2**5*c*e*(7*y1 + 4*y2) +
          b2**7*(17*y1 + 11*y2) + b2**3*c**2*e**2*(89*y1 + 47*y2)) -
        2*a**2*c**2*(-40*b2**6*(x1 - x2) - 122*b2**4*c*e*(x1 - x2) - 52*b2**2*c**2*e**2*(x1 - x2) +
          2*c**3*e**3*(-x1 + x2) + 6*b2**3*c**2*e*(11*y1 + 19*y2) + b2*c**3*e**2*(11*y1 + 19*y2) +
          b2**5*c*(43*y1 + 83*y2)) + a*h*(9*b2**8*(x1 - x2) + 174*b2**6*c*e*(x1 - x2) +
          348*b2**4*c**2*e**2*(x1 - x2) + 138*b2**2*c**3*e**3*(x1 - x2) + 3*c**4*e**4*(x1 - x2) -
          2*b2*c**4*e**3*(19*y1 + 17*y2) - 2*b2**7*c*(25*y1 + 31*y2) - 2*b2**3*c**3*e**2*
           (139*y1 + 133*y2) - 2*b2**5*c**2*e*(153*y1 + 155*y2))) +
      b1**2*(e**4*h**5*(-10*b2**3*e*(x1 - x2) + 2*b2*c*e**2*(-x1 + x2) + c**2*e**2*y1 +
          b2**2*c*e*(25*y1 + 3*y2) + b2**4*(46*y1 + 9*y2)) +
        a**5*c**5*(-56*b2**3*(x1 - x2) - 16*b2*c*e*(x1 - x2) + c**2*e*(y1 + 5*y2) +
          b2**2*c*(11*y1 + 67*y2)) + a*e**2*h**4*(-55*b2**5*e*(x1 - x2) - 58*b2**3*c*e**2*(x1 - x2) +
          7*b2*c**2*e**3*(-x1 + x2) + 2*c**3*e**3*y1 + b2**2*c**2*e**2*(59*y1 + 15*y2) +
          b2**6*(70*y1 + 38*y2) + b2**4*c*e*(169*y1 + 67*y2)) +
        a**4*c**3*h*(-125*b2**5*(x1 - x2) - 152*b2**3*c*e*(x1 - x2) - 23*b2*c**2*e**2*(x1 - x2) +
          c**3*e**2*(2*y1 + 3*y2) + 25*b2**4*c*(3*y1 + 8*y2) + b2**2*c**2*e*(43*y1 + 97*y2)) +
        a**2*h**3*(-36*b2**7*e*(x1 - x2) - 179*b2**5*c*e**2*(x1 - x2) - 130*b2**3*c**2*e**3*(x1 - x2) -
          15*b2*c**3*e**4*(x1 - x2) + 3*c**4*e**4*y1 + 3*b2**8*(4*y1 + 3*y2) +
          6*b2**2*c**3*e**3*(13*y1 + 7*y2) + 2*b2**6*c*e*(67*y1 + 65*y2) +
          b2**4*c**2*e**2*(253*y1 + 179*y2)) + a**3*c*h**2*(-48*b2**7*(x1 - x2) - 229*b2**5*c*e*(x1 - x2) -
          182*b2**3*c**2*e**2*(x1 - x2) - 21*b2*c**3*e**3*(x1 - x2) + c**4*e**3*(3*y1 + y2) +
          12*b2**6*c*(7*y1 + 11*y2) + 4*b2**2*c**3*e**2*(18*y1 + 19*y2) +
          b2**4*c**2*e*(201*y1 + 271*y2))) +
      b1**3*(e**3*h**4*(37*b2**4*e*(x1 - x2) + 22*b2**2*c*e**2*(x1 - x2) + c**2*e**3*(x1 - x2) -
          28*b2**3*c*e*(4*y1 + y2) - b2*c**2*e**2*(17*y1 + 3*y2) - b2**5*(91*y1 + 29*y2)) -
        2*a**4*c**4*(-64*b2**4*(x1 - x2) - 44*b2**2*c*e*(x1 - x2) + 2*c**2*e**2*(-x1 + x2) +
          b2*c**2*e*(7*y1 + 23*y2) + b2**3*c*(23*y1 + 87*y2)) -
        a*e*h**3*(-94*b2**6*e*(x1 - x2) - 223*b2**4*c*e**2*(x1 - x2) - 80*b2**2*c**2*e**3*(x1 - x2) +
          3*c**3*e**4*(-x1 + x2) + 16*b2**7*(4*y1 + 3*y2) + b2*c**3*e**3*(35*y1 + 13*y2) +
          2*b2**3*c**2*e**2*(141*y1 + 67*y2) + b2**5*c*e*(339*y1 + 205*y2)) -
        a**3*c**2*h*(-158*b2**6*(x1 - x2) - 401*b2**4*c*e*(x1 - x2) - 156*b2**2*c**2*e**2*(x1 - x2) +
          5*c**3*e**3*(-x1 + x2) + b2*c**3*e**2*(33*y1 + 47*y2) + 2*b2**3*c**2*e*(103*y1 + 177*y2) +
          b2**5*c*(161*y1 + 319*y2)) + a**2*h**2*(19*b2**8*(x1 - x2) + 232*b2**6*c*e*(x1 - x2) +
          445*b2**4*c**2*e**2*(x1 - x2) + 138*b2**2*c**3*e**3*(x1 - x2) + 6*c**4*e**4*(x1 - x2) -
          4*b2**7*c*(19*y1 + 23*y2) - b2*c**4*e**3*(41*y1 + 31*y2) - 2*b2**3*c**3*e**2*(167*y1 + 145*y2) -
          b2**5*c**2*e*(389*y1 + 427*y2))) +
      b1**4*(e**2*h**3*(-62*b2**5*e*(x1 - x2) - 84*b2**3*c*e**2*(x1 - x2) - 14*b2*c**2*e**3*(x1 - x2) +
          c**3*e**3*(3*y1 + y2) + 2*b2**2*c**2*e**2*(44*y1 + 15*y2) + b2**6*(86*y1 + 40*y2) +
          b2**4*c*e*(223*y1 + 89*y2)) + a**3*c**3*(-148*b2**5*(x1 - x2) - 216*b2**3*c*e*(x1 - x2) -
          36*b2*c**2*e**2*(x1 - x2) + 22*b2**2*c**2*e*(3*y1 + 7*y2) + c**3*e**2*(3*y1 + 7*y2) +
          b2**4*c*(91*y1 + 239*y2)) + a*h**2*(-62*b2**7*e*(x1 - x2) - 330*b2**5*c*e**2*(x1 - x2) -
          290*b2**3*c**2*e**3*(x1 - x2) - 38*b2*c**3*e**4*(x1 - x2) + c**4*e**4*(5*y1 + 4*y2) +
          b2**8*(16*y1 + 19*y2) + 4*b2**6*c*e*(65*y1 + 54*y2) + 2*b2**2*c**3*e**3*(89*y1 + 55*y2) +
          b2**4*c**2*e**2*(501*y1 + 371*y2)) + a**2*c*h*(-78*b2**7*(x1 - x2) - 440*b2**5*c*e*(x1 - x2) -
          390*b2**3*c**2*e**2*(x1 - x2) - 52*b2*c**3*e**3*(x1 - x2) + c**4*e**3*(5*y1 + 7*y2) +
          6*b2**6*c*(25*y1 + 38*y2) + 2*b2**2*c**3*e**2*(82*y1 + 95*y2) +
          b2**4*c**2*e*(401*y1 + 535*y2))))/(a**7*c**8 - 8*b1**7*b2*c*(b2**6 + 7*b2**4*c*e +
        7*b2**2*c**2*e**2 + c**3*e**3) + 7*a**6*b2**2*c**6*h + 3*a**5*b2**2*c**4*(5*b2**2 + 2*c*e)*h**2 +
      5*a**4*b2**2*c**2*(2*b2**4 + 4*b2**2*c*e + c**2*e**2)*h**3 +
      a**3*b2**2*(b2**6 + 12*b2**4*c*e + 18*b2**2*c**2*e**2 + 4*c**3*e**3)*h**4 +
      3*a**2*b2**2*e**2*(2*b2**4 + 4*b2**2*c*e + c**2*e**2)*h**5 + a*b2**2*e**4*(5*b2**2 + 2*c*e)*h**6 +
      b2**2*e**6*h**7 + b1**6*(4*a*c**2*(21*b2**6 + 63*b2**4*c*e + 27*b2**2*c**2*e**2 + c**3*e**3) +
        (7*b2**8 + 112*b2**6*c*e + 238*b2**4*c**2*e**2 + 88*b2**2*c**3*e**3 + 3*c**4*e**4)*h) -
      4*b1**5*b2*(3*a**2*c**3*(21*b2**4 + 30*b2**2*c*e + 5*c**2*e**2) +
        2*a*c*(14*b2**6 + 77*b2**4*c*e + 68*b2**2*c**2*e**2 + 9*c**3*e**3)*h +
        e*(14*b2**6 + 77*b2**4*c*e + 68*b2**2*c**2*e**2 + 9*c**3*e**3)*h**2) +
      b1**4*(10*a**3*c**4*(33*b2**4 + 22*b2**2*c*e + c**2*e**2) + 6*a**2*c**2*(63*b2**6 + 156*b2**4*c*e +
          59*b2**2*c**2*e**2 + 2*c**3*e**3)*h + a*(35*b2**8 + 476*b2**6*c*e + 872*b2**4*c**2*e**2 +
          288*b2**2*c**3*e**3 + 9*c**4*e**4)*h**2 + 2*e**2*(63*b2**6 + 156*b2**4*c*e + 59*b2**2*c**2*e**2 +
          2*c**3*e**3)*h**3) - 4*b1**3*b2*(5*a**4*c**5*(11*b2**2 + 3*c*e) +
        20*a**3*c**3*(6*b2**4 + 7*b2**2*c*e + c**2*e**2)*h + 6*a**2*c*(7*b2**6 + 34*b2**4*c*e +
          26*b2**2*c**2*e**2 + 3*c**3*e**3)*h**2 + 4*a*e*(7*b2**6 + 34*b2**4*c*e + 26*b2**2*c**2*e**2 +
          3*c**3*e**3)*h**3 + 5*e**3*(6*b2**4 + 7*b2**2*c*e + c**2*e**2)*h**4) +
      b1**2*(6*a**5*c**6*(13*b2**2 + c*e) + 5*a**4*c**4*(55*b2**4 + 28*b2**2*c*e + c**2*e**2)*h +
        4*a**3*c**2*(54*b2**6 + 118*b2**4*c*e + 37*b2**2*c**2*e**2 + c**3*e**3)*h**2 +
        3*a**2*(7*b2**8 + 88*b2**6*c*e + 144*b2**4*c**2*e**2 + 40*b2**2*c**3*e**3 + c**4*e**4)*h**3 +
        2*a*e**2*(54*b2**6 + 118*b2**4*c*e + 37*b2**2*c**2*e**2 + c**3*e**3)*h**4 +
        e**4*(55*b2**4 + 28*b2**2*c*e + c**2*e**2)*h**5) -
      2*b1*b2*(7*a**6*c**7 + 6*a**5*c**5*(6*b2**2 + c*e)*h + 5*a**4*c**3*(10*b2**4 + 10*b2**2*c*e + c**2*e**2)*
         h**2 + 4*a**3*c*(4*b2**6 + 18*b2**4*c*e + 12*b2**2*c**2*e**2 + c**3*e**3)*h**3 +
        3*a**2*e*(4*b2**6 + 18*b2**4*c*e + 12*b2**2*c**2*e**2 + c**3*e**3)*h**4 +
        2*a*e**3*(10*b2**4 + 10*b2**2*c*e + c**2*e**2)*h**5 + e**5*(6*b2**2 + c*e)*h**6))




  }

function reset(S, I, O, P) {
  if(P.userandominit) {
  S.x = (Math.random()-0.5)*400
  S.y = (Math.random()-0.5)*400 
   }
  else {
    S.x = 0
    S.y = -150
   }
  S.xcostsmoothed = null
  P.draggables = 
   [{x: P.xnash*P.scale, y:P.ynash*P.scale, isDragging: false},
    {x: P.xstack1*P.scale, y:P.ystack1*P.scale, isDragging: false},
    {x: P.xstack2*P.scale, y:P.ystack2*P.scale, isDragging: false},
    {x: P.xconj*P.scale, y:P.yconj*P.scale, isDragging: false}]
  
  recompute(P)
 }

function update(S, I, O, P) {
  var xx1 = (S.x-P.x1*P.scale)
  var yy1 = (S.y-P.y1*P.scale)
  var xx2 = (S.x-P.x2*P.scale)
  var yy2 = (S.y-P.y2*P.scale)

  O.costx = P.a*xx1*xx1/2 + P.b*xx1*yy1 + P.h*yy1*yy1/2
  O.costy = P.d*yy2*yy2/2 + P.c*xx2*yy2 + P.e*xx2*xx2/2
  O.costx /= P.scale**2
  O.costy /= P.scale**2
  
  if(S.xcostsmoothed === null) {
    S.xcostsmoothed = O.costx
   }
  else
  {
    S.xcostsmoothed = P.smooth*S.xcostsmoothed + (1-P.smooth)*O.costx
   }

  O.gradx = P.a*xx1 + P.b*yy1
  O.grady = P.c*xx2 + P.d*yy2
  
  O.gradstackx = O.gradx - (P.c*(P.b*xx1+P.h*yy1))/P.d
  O.gradstacky = O.grady - (P.b*(P.c*yy2+P.e*xx2))/P.a
  O.gradconjx = O.gradx + P.k*(P.b*xx1+P.h*yy1)
  O.gradconjy = O.grady + P.l*(P.c*yy2+P.e*xx2)
  if (P.usenoise) {
    O.gradx += 2*(Math.random()-0.5)*P.noisestdx**2
    O.grady += 2*(Math.random()-0.5)*P.noisestdy**2
    O.gradstackx += 2*(Math.random()-0.5)*P.noisestdx**2
    O.gradstacky += 2*(Math.random()-0.5)*P.noisestdy**2
   }
  const gradx = P.playconjx ? O.gradconjx : O.gradx
  const grady = P.playconjy ? O.gradconjy : O.grady
  switch (P.mode) {
    case 'simgrad':
     S.x = S.x - P.alpha*gradx
     S.y = S.y - P.beta*grady
     break;
    case 'mouse': 
     S.x = I.posX
     S.y = S.y - P.beta*grady
     break;
    case 'both':
     S.x = I.posX
     S.y = I.posY
     break;
   }
}

function draw(canvas, S, I, O, P, H) {
  let ctx = canvas.getContext('2d')
  let w = canvas.width
  let h = canvas.height

  recompute(P)

  ctx.strokeStyle = 'white'
  ctx.fillStyle = 'black'
  ctx.lineWidth = 3

  ctx.font = '36px Unknown Font, sans-serif'
  ctx.save();
  ctx.lineWidth = 20
  ctx.strokeStyle = 'black'
  ctx.setTransform(1,0,0,1,0,0)
  ctx.fillText(O.costx.toFixed(2), 20, 40)
  if (P.showcostdiff) {
  ctx.beginPath();
  ctx.moveTo(0, 30);
  dcost = S.xcostsmoothed-O.costx
  if (dcost<0) ctx.strokeStyle = '#882143'
  if (dcost>0) ctx.strokeStyle = '#007e00'
  ctx.lineTo(0, 30+dcost*P.scalecost);
  ctx.stroke();
   }
  ctx.restore();

  //ctx.strokeRect(-w/2, -h/2, w, h)

  if(P.showinfo && P.showcostx){
  ctx.strokeStyle = P.colorcost1
  r1 = (P.a+P.h)/2 + Math.sqrt((P.a - P.h)**2/4+P.b*P.b)
  r2 = (P.a+P.h)/2 - Math.sqrt((P.a - P.h)**2/4+P.b*P.b)
  t = Math.atan2(r1-P.a, P.b)
  for (var i=1; i<5; i++) {
  ctx.beginPath();
  ctx.ellipse(P.x1*P.scale, P.y1*P.scale, Math.sqrt(r2)*i*P.scale*P.lvlset, Math.sqrt(r1)*i*P.scale*P.lvlset, t, 0, 2*Math.PI)
  ctx.stroke()
   }

//  for (var i=1; i<10; i++) {
//  ctx.beginPath();
//  x = -10*P.scale
//  ctx.moveTo(x, (-P.b*(x-P.x1*P.scale)-Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(x-P.x1*P.scale)**2-P.a*P.h*(x-P.x1*P.scale)**2))/P.h + P.y1*P.scale)
//  for (x = x ; x<10*P.scale; x+=0.1){
//  ctx.lineTo(x, (-P.b*(x-P.x1*P.scale)-Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(x-P.x1*P.scale)**2-P.a*P.h*(x-P.x1*P.scale)**2))/P.h + P.y1*P.scale)
//   }
//  ctx.stroke()
//   
//  for (var i=1; i<10; i++) {
//  ctx.beginPath();
//  x = -10*P.scale
//  ctx.moveTo(x, (-P.b*(x-P.x1*P.scale)+Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(x-P.x1*P.scale)**2-P.a*P.h*(x-P.x1*P.scale)**2))/P.h + P.y1*P.scale)
//  for (x = x ; x<10*P.scale; x+=0.1){
//  ctx.lineTo(x, (-P.b*(x-P.x1*P.scale)+Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(x-P.x1*P.scale)**2-P.a*P.h*(x-P.x1*P.scale)**2))/P.h + P.y1*P.scale)
//   }
//  ctx.stroke()
//   }
//   }


//  for (var i=1; i<10; i++) {
//  ctx.beginPath();
//  y = -10*P.scale
//  ctx.moveTo((-P.b*(y-P.y1*P.scale)-Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(y-P.y1*P.scale)**2-P.a*P.h*(y-P.y1*P.scale)**2))/P.a + P.y1*P.scale,y)
//  for (y = y ; y<10*P.scale; y+=0.1){
//  ctx.lineTo((-P.b*(y-P.y1*P.scale)-Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(y-P.y1*P.scale)**2-P.a*P.h*(y-P.y1*P.scale)**2))/P.a + P.x1*P.scale, y)
//   }
//  ctx.stroke()
//   
//  for (var i=1; i<10; i++) {
//  ctx.beginPath();
//  x = -10*P.scale
//  ctx.moveTo((-P.b*(y-P.y1*P.scale)+Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(y-P.y1*P.scale)**2-P.a*P.h*(y-P.y1*P.scale)**2))/P.a + P.y1*P.scale,y)
//  for (y = y ; y<10*P.scale; y+=0.1){
//  ctx.lineTo((-P.b*(y-P.y1*P.scale)+Math.sqrt(2*P.lvlset**2*P.scale*i**2*P.h+P.b**2*(y-P.y1*P.scale)**2-P.a*P.h*(y-P.y1*P.scale)**2))/P.a + P.x1*P.scale, y)
//   }
//  ctx.stroke()
//   }
//   }


  ctx.beginPath();
  ctx.arc(P.x1*P.scale, P.y1*P.scale, 1, 0, 2*Math.PI)
  ctx.fill()

   }

  if(P.showinfo && P.showcosty){
  ctx.strokeStyle = P.colorcost2
  r1 = (P.d+P.e)/2 + Math.sqrt((P.e - P.d)**2/4+P.c*P.c)
  r2 = (P.d+P.e)/2 - Math.sqrt((P.e - P.d)**2/4+P.c*P.c)
  t = Math.atan2(r1-P.e, P.c)
  for (var i=0; i<5; i++) {
  ctx.beginPath();
  ctx.ellipse(P.x2*P.scale, P.y2*P.scale, Math.sqrt(r2)*i*P.scale*P.lvlset, Math.sqrt(r1)*i*P.scale*P.lvlset, t, 0, 2*Math.PI)

  ctx.stroke()
   }
  ctx.beginPath();
  ctx.arc(P.x2*P.scale, P.y2*P.scale, 1, 0, 2*Math.PI)
  ctx.fill()
   }

  ctx.lineWidth = 20;
  if (P.mode == 'both') {
    x = I.posX
    y = I.posY
   } else if (P.mode == 'mouse') {
     x = I.posX
     y = S.y
   } else if (P.mode == 'simgrad') {
     x = S.x
     y = S.y
    }


    xx1 = (x-P.x1*P.scale)
    yy1 = (y-P.y1*P.scale)
    gradx = P.a*xx1 + P.b*yy1
    gradstackx = gradx - P.c*(P.b*xx1+P.h*yy1)/P.d

    const shifty = h/2-50
    const mc = 200
    const mg = 30
    const scalecost = 1/100
    const scalegrad = 1/100
  ctx.lineWidth = 6

  if (P.showcostcurvature) {
  ctx.beginPath();
    ctx.strokeStyle = "#3855A7"
  ctx.moveTo(x-mc, (-mc*gradx + P.a*(-mc)**2 )*scalegrad+shifty)
  for(var dx = -mc; dx < mc; dx+=0.1) {
    ctx.lineTo(x+dx, (dx*gradx + P.a*dx**2)*scalegrad+shifty)
   }
  ctx.stroke()
   }
  if (P.showcostgradient) {
    ctx.beginPath();
    ctx.strokeStyle = "#6C8CF1"
    ctx.moveTo(x-mg, -mg*gradx*scalegrad+shifty)
    for(var dx = -mg; dx < mg; dx+=1) {
      ctx.lineTo(x+dx, dx*gradx*scalegrad+shifty)
     }
    ctx.stroke()
   } 
  if (P.showcoststackcurvature) {
  ctx.beginPath();
    ctx.strokeStyle = "#0DAAAD"
  ctx.moveTo(x-mc, (-mc*gradstackx + (P.a-P.b*P.c)/P.d*(-mc)**2 )*scalegrad+shifty)
  for(var dx = -mc; dx < mc; dx+=0.1) {
    ctx.lineTo(x+dx, (dx*gradstackx + P.a*dx**2)*scalegrad+shifty)
   }
  ctx.stroke()
   }
  if (P.showcoststackgradient) {
    ctx.beginPath();
    ctx.strokeStyle = "#40CDD2"
    ctx.moveTo(x-mg, -mg*gradstackx*scalegrad+shifty)
    for(var dx = -mg; dx < mg; dx+=1) {
      ctx.lineTo(x+dx, dx*gradstackx*scalegrad+shifty)
     }
    ctx.stroke()
   } 
  if(P.showcostgradient || P.showcostcurvature) {
  ctx.beginPath();
  ctx.strokeStyle = P.colorx
   ctx.moveTo(x-3, shifty)
   ctx.lineTo(x+3, shifty)
  ctx.stroke()


   }else {
  ctx.lineWidth = 20
  ctx.strokeStyle = P.colorx
  ctx.beginPath();
   ctx.moveTo(x-5, h/2)
   ctx.lineTo(x+5, h/2)
  ctx.stroke()
   }

  if (P.mode != 'mouse' || P.showinfo) {
  ctx.strokeStyle = P.colory
   ctx.beginPath();
   ctx.moveTo(w/2, y-5) 
   ctx.lineTo(w/2, y+5)
   ctx.stroke()
   }


  ctx.lineWidth = 2
  if (P.history && H.S.x.length >= 1) {
  ctx.strokeStyle = "black"
   ctx.beginPath();
   ctx.moveTo(H.S.x[0], H.S.y[0]) 
    for (var i =0; i< H.S.x.length; i+= 2) {
ctx.lineTo(H.S.x[i], H.S.y[i])
     }
   ctx.stroke()
   }

  
  if(P.showinfo){


  ctx.fillStyle = 'black'
  ctx.beginPath();
  ctx.arc(S.x, S.y, 8, 0, 2*Math.PI)
  ctx.fill()

    

  if(P.showgstacktwo){
  ctx.fillStyle = P.colorstacktwo
  ctx.beginPath();
  ctx.arc(P.xstacktwo*P.scale, P.ystacktwo*P.scale, P.pointradius, 0, 2*Math.PI)
  ctx.fill()
  ctx.strokeStyle = P.colorstacktwo
  // gstack1
  ctx.beginPath();
  const dx = (P.x1-P.xstacktwo)*100
  const dy = (P.y1-P.ystacktwo)*100
  ctx.moveTo(P.x1*P.scale-dx*P.scale,P.y1*P.scale-dy*P.scale)
  ctx.lineTo(P.x1*P.scale+dx*P.scale,P.y1*P.scale+dy*P.scale)
  ctx.stroke();
   }

    if(P.showg1){
  // g1
  ctx.fillStyle = P.colornash1
  ctx.strokeStyle = P.colornash1
  ctx.beginPath();
  y=-500;ctx.moveTo(P.b*(P.y1*P.scale-y)/P.a+P.x1*P.scale,y)
  y=500; ctx.lineTo(P.b*(P.y1*P.scale-y)/P.a+P.x1*P.scale,y)
  ctx.stroke();
     }

    if(P.showg2) {
  // g2
  ctx.fillStyle = P.colornash2
  ctx.strokeStyle = P.colornash2
  ctx.beginPath();
  x=-500;ctx.moveTo(x,P.c*(P.x2*P.scale-x)/P.d+P.y2*P.scale)
  x=500; ctx.lineTo(x,P.c*(P.x2*P.scale-x)/P.d+P.y2*P.scale)
  ctx.stroke();
   }
    if(P.showg1 && P.showg2){
  ctx.fillStyle = P.colornash
  ctx.strokeStyle = P.colornash
  ctx.beginPath();
  ctx.arc(P.xnash*P.scale, P.ynash*P.scale, P.pointradius, 0, 2*Math.PI)
  ctx.fill()
   }

    if(P.showgstack1){
  ctx.fillStyle = P.colorstack1
  ctx.strokeStyle = P.colorstack1
      ctx.setLineDash([5,3])
  ctx.beginPath();
  ctx.arc(P.xstack1*P.scale, P.ystack1*P.scale, P.pointradius, 0, 2*Math.PI)
  ctx.fill()
  // gstack1
  ctx.beginPath();
  y=-500;ctx.moveTo((P.c*P.h-P.b*P.d)*(P.y1*P.scale-y)/(P.b*P.c-P.a*P.d)+P.x1*P.scale,y)
  y=500; ctx.lineTo((P.c*P.h-P.b*P.d)*(P.y1*P.scale-y)/(P.b*P.c-P.a*P.d)+P.x1*P.scale,y)
  ctx.stroke();
     }

    if(P.showgstack2){
  ctx.fillStyle = P.colorstack2
  ctx.strokeStyle = P.colorstack2
      ctx.setLineDash([5,3])
  // gstack2
      if(P.machinestack) ctx.lineWidth=4
  ctx.beginPath();
  x=-500;ctx.moveTo(x,(P.a*P.c-P.b*P.e)*(P.x2*P.scale-x)/(P.a*P.d-P.b*P.c)+P.y2*P.scale);
  x=500; ctx.lineTo(x,(P.a*P.c-P.b*P.e)*(P.x2*P.scale-x)/(P.a*P.d-P.b*P.c)+P.y2*P.scale);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(P.xstack2*P.scale, P.ystack2*P.scale, P.pointradius, 0, 2*Math.PI)
  ctx.fill()
      ctx.lineWidth=2
     }

      ctx.setLineDash([])

    if(P.showgrevstack1){
  ctx.beginPath();
  y=-500;ctx.moveTo(-(P.c*(P.x1-P.x2)+P.d*(P.y1-P.y2))/(P.e*(P.x1-P.x2)+P.c*(P.y1-P.y2))*(P.y1*P.scale-y)+P.x1*P.scale,y)
  y=500;ctx.lineTo(-(P.c*(P.x1-P.x2)+P.d*(P.y1-P.y2))/(P.e*(P.x1-P.x2)+P.c*(P.y1-P.y2))*(P.y1*P.scale-y)+P.x1*P.scale,y)
  ctx.stroke();
   }
    if(P.showgrevstack2){
  ctx.beginPath();
  y=-500;ctx.moveTo(-(P.b*(P.y2-P.y1)+P.a*(P.x2-P.x1))/(P.h*(P.y2-P.y1)+P.b*(P.x2-P.x1))*(P.y2*P.scale-y)+P.x2*P.scale,y)
  y=500;ctx.lineTo(-(P.b*(P.y2-P.y1)+P.a*(P.x2-P.x1))/(P.h*(P.y2-P.y1)+P.b*(P.x2-P.x1))*(P.y2*P.scale-y)+P.x2*P.scale,y)
  ctx.stroke();
   }

    if(P.showgconj){
  ctx.fillStyle = P.colorconj
  ctx.beginPath();
  ctx.arc(P.xconj*P.scale, P.yconj*P.scale, P.pointradius, 0, 2*Math.PI)
  ctx.fill()
     }

    if(P.showgstacktwo1){
  ctx.fillStyle = P.colorstacktwo
  ctx.strokeStyle = P.colorstacktwo
  ctx.beginPath();
  ctx.arc(P.xstacktwo1*P.scale, P.ystacktwo1*P.scale, 5, 0, 2*Math.PI)
  ctx.fill()
     }
    if(P.showgstackthree1){
  ctx.fillStyle = P.colorstacktwo
  ctx.strokeStyle = P.colorstacktwo
  ctx.beginPath();
  ctx.arc(P.xstackthree1*P.scale, P.ystackthree1*P.scale, 5, 0, 2*Math.PI)
  ctx.fill()
     }
    if(P.showgstackfour1){
  ctx.fillStyle = P.colorstacktwo
  ctx.strokeStyle = P.colorstacktwo
  ctx.beginPath();
  ctx.arc(P.xstackfour1*P.scale, P.ystackfour1*P.scale, 5, 0, 2*Math.PI)
  ctx.fill()
     }
  ctx.beginPath();
    ctx.stroke()
    if(P.showgallconj){
      ctx.lineWidth = 1
      k = 0
      l = 0
      for (var i=0; i <= 30; i++) {
        //if (i % 2 == 0) {
        k = -(P.c+P.e*l)/(P.d+P.c*l)
        // }
        //else{
        l = -(P.b+P.h*k)/(P.a+P.b*k)
        // }

        ctx.strokeStyle = 'orange'
        ctx.beginPath();
        y=-500;ctx.moveTo((P.b+P.h*k)/(P.a+P.b*k)*(P.y1*P.scale-y)+P.x1*P.scale,y);
        y=500;ctx.lineTo((P.b+P.h*k)/(P.a+P.b*k)*(P.y1*P.scale-y)+P.x1*P.scale,y);
        ctx.stroke();
        ctx.strokeStyle = 'yellow'

        ctx.beginPath();
        x=-500;ctx.moveTo(x, (P.c+P.e*l)*(P.x2*P.scale-x)/(P.d+P.c*l)+P.y2*P.scale)
        x=500;ctx.lineTo(x, (P.c+P.e*l)*(P.x2*P.scale-x)/(P.d+P.c*l)+P.y2*P.scale)
        ctx.stroke();
       }
      P.k_opt = k;
      P.l_opt = l;

  ctx.fillStyle = P.colorstacktwo
  ctx.strokeStyle = P.colorstacktwo


      for (i=-1; i<=1; i+=2) {
       l= -((P.a*P.d - P.h*P.e +i*
     Math.sqrt(4*(P.b*P.d - P.c*P.h)*((-P.a)*P.c + P.b*P.e) + (P.a*P.d - 
          P.h*P.e)**2))/(2*P.a*P.c - 
     2*P.b*P.e)), 

      k=
       -((P.a*P.d - P.h*P.e +i*
     Math.sqrt(4*(P.b*P.d - P.c*P.h)*((-P.a)*P.c + P.b*P.e) + (P.a*P.d -
          P.h*P.e)**2))/(2*P.b*P.d - 2*P.c*P.h))

   xallconj =  (P.a*(P.d + P.c*l)*P.x1 +
   P.b*(P.d*(k*P.x1 + P.y1 - P.y2) + P.c*(k*l*P.x1 - P.x2 + l*P.y1 - l*P.y2) -
      l*P.x2*P.e) -
      P.h*k*(P.d*(-P.y1 + P.y2) + P.c*(P.x2 + l*(-P.y1 + P.y2)) +
      l*P.x2*P.e))/
   (P.a*(P.d + P.c*l) + P.b*(P.d*k + P.c*(-1 + k*l) - l*P.e) -
   P.h*k*(P.c + l*P.e))

   yallconj =  ((-P.h)*k*P.y1*(P.c + l*P.e) +
   P.a*(P.d*P.y2 + P.c*(-P.x1 + P.x2 + l*P.y2) + l*(-P.x1 + P.x2)*P.e) +
      P.b*((-P.c)*P.y1 + P.d*k*P.y2 + P.c*k*(-P.x1 + P.x2 + l*P.y2) -
      l*(k*(P.x1 - P.x2) + P.y1)*P.e))/
   (P.a*(P.d + P.c*l) + P.b*(P.d*k + P.c*(-1 + k*l) - l*P.e) -
   P.h*k*(P.c + l*P.e))

  ctx.fillStyle = 'pink'
  ctx.beginPath();
  ctx.arc(xallconj*P.scale, yallconj*P.scale, 8, 0, 2*Math.PI)
  ctx.fill()
       }


     }
   } // end show info

  

 }

function inputs(canvas, S, I, O, P, x, y) {

  if (P.inputmode == 'lock') {
    I.movX = I.movX + x 
    I.movY = I.movY - y
  //}
  //if (P.inputmode == 'absolute') {
  //  I.posX = x - canvas.width/2
  //  I.posY = canvas.height -y
  //}
    I.posX = I.movX
    I.posY = I.movY
   } else {
    I.posX = x - canvas.width/2
    I.posY = canvas.height/2 -y
    }

  if (P.mode == 'lqr') I.posX = x

}

function truncate(P) {
  const s = 10;
  P.a = Math.round(P.a*s)/s;
  P.b = Math.round(P.b*s)/s;
  P.c = Math.round(P.c*s)/s;
  P.d = Math.round(P.d*s)/s;
  P.e = Math.round(P.e*s)/s;
  P.h = Math.round(P.h*s)/s;
  P.x1 = Math.round(P.x1*s)/s;
  P.x2 = Math.round(P.x2*s)/s;
}

DynamSpace(update, draw, inputs, reset, truncate, data, experiments, )

	</script>
</body>
</html>
